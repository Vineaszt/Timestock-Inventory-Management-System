<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=0.55">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Times Stock IMS</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp" rel="stylesheet">
  <link rel="stylesheet" href="../css/Settings.css?v=6">
  <style>
  @media screen and (max-width: 768px) {

  /* Container collapse */
  .container {
    grid-template-columns: 1fr; /* hide sidebar, full width */
    padding: 0 1rem;
  }

  /* Header adjustments */
  .header-bar {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    padding: 0 1rem;
    margin-bottom: 1rem;
  }

  .top-bar {
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  /* Main content vertical stack */
  main {
    margin-top: 1rem;
    padding: 0 0.5rem;
  }

  /* Maintenance card stack */
  .maintenance-card {
    padding: 0.8rem;
  }

  .maintenance-row {
    flex-direction: column;
    gap: 6px;
    align-items: stretch;
  }

  .maintenance-row input[type="number"] {
    width: 100%;
  }

  /* Tables scroll horizontally */
  .table-wrapper,
  .table-container,
  #auditTable {
    overflow-x: auto;
  }

  #auditTable thead, 
  #auditTable tbody tr {
    display: table;
    width: 100%;
    table-layout: fixed;
  }

  #auditTable tbody {
    display: block;
    max-height: 250px;
    overflow-y: auto;
  }

  #auditTable tbody td {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Pagination wraps */
  .pagination {
    flex-wrap: wrap;
    justify-content: center;
    gap: 6px;
  }

  .pagination button {
    padding: 5px 10px;
    font-size: 0.75rem;
  }

  /* Modal full width */
  .modal-content {
    width: 95%;
    max-width: 400px;
    padding: 1rem;
  }

  .modal-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  .modal-actions {
    flex-direction: column-reverse;
    gap: 6px;
  }

  /* Form grid stacks vertically */
  .form-grid {
    grid-template-columns: 1fr;
    gap: 10px;
  }

  .form-group.full-width {
    grid-column: 1 / -1;
  }

  .modal-content input,
  .modal-content select {
    width: 100%;
  }

  /* Buttons full width for touch targets */
  .btn,
  .btn-danger,
  .demo-btn,
  #migrateBtn {
    width: 100%;
    margin-bottom: 8px;
  }

  /* Slider adjustments for vertical orientation */
  .vertical-range {
    width: 100%; /* full width slider */
    height: 24px;
    transform: rotate(0deg); /* horizontal on mobile */
    margin: 8px 0;
  }

  input[type="range"] {
    width: 100%;
    height: 32px;
  }

  /* Optional: reduce font sizes for small screens */
  .modal-content h3 {
    font-size: 16px;
  }

  .modal-content p,
  .modal-content ul li,
  .muted {
    font-size: 13px;
  }

  /* Slider container adjust */
  .slider-container {
    width: 100%;
    justify-content: flex-start;
    padding-top: 4px;
  }
}

  </style>
</head>
<body>
  <div class="container">
    <aside>
      <div class="top">
        <div class="logo">
          <img src="../images/TIMESTOCK_BG.png">
        </div>
          <h2>TIME<span class="danger">STOCK</span></h2>

    </div>
    <div class="mobile-menu-btn">
      <span class="material-symbols-sharp">menu</span>
    </div>
       {% include "sidebar.html" %}
</aside>
<!-----END OF ASIDE MUENU----->
<main>
  <div class="header-bar">
  <h1>Settings Management</h1>
  <div class="top-bar">
        {% include 'alert.html' %}
        {% include "profile.html" %}
  </div>
</div>
    <div class="demo-buttons">
        <button class="demo-btn" onclick="openModal('addAdminModal')">Add Admin</button>
        <button class="demo-btn" onclick="openModal('addEmployeeModal')">Add Employee</button>
        <button class="demo-btn" onclick="openModal('statusModal')">Change Status</button>
        <button class="demo-btn" onclick="openModal('passwordModal')">Change Employee Password</button>
        <button class="demo-btn" onclick="openModal('changeAdminPasswordModal')">Change Your Password</button>
        <!-- <button class="demo-btn" onclick="openModal('migrateModal')">Migration</button> -->
    </div>


<!-- Change Admin Password Modal -->
<div id="changeAdminPasswordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Change Admin Password</h2>
            <span class="close" onclick="closeModal('changeAdminPasswordModal')">&times;</span>
        </div>

        <form id="changeAdminPasswordForm" onsubmit="changeAdminPassword(event)">
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="current_admin_password">Current Password</label>
                        <input type="password" id="current_admin_password" name="current_password" placeholder="Enter current password" required>
                    </div>

                    <div class="form-group full-width">
                        <label for="new_admin_password">New Password</label>
                        <input type="password" id="new_admin_password" name="new_password" placeholder="Enter new password" required minlength="8">
                    </div>

                    <div class="form-group full-width">
                        <label for="confirm_admin_password">Confirm New Password</label>
                        <input type="password" id="confirm_admin_password" name="confirm_password" placeholder="Confirm new password" required minlength="8">
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button type="submit">Update Password</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Admin Modal -->
<div id="addAdminModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add Admin Account</h2>
            <span class="close" onclick="closeModal('addAdminModal')">&times;</span>
        </div>

        <form id="addAdminForm" onsubmit="createAdmin(event)">
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="admin_firstname">First Name</label>
                        <input type="text" id="admin_firstname" name="firstname" placeholder="First Name" required>
                    </div>

                    <div class="form-group">
                        <label for="admin_lastname">Last Name</label>
                        <input type="text" id="admin_lastname" name="lastname" placeholder="Last Name" required>
                    </div>

                    <div class="form-group full-width">
                        <label for="admin_email">Email</label>
                        <input type="email" id="admin_email" name="email" placeholder="Email Address" required>
                    </div>

                    <div class="form-group full-width">
                        <label for="admin_password">Password</label>
                        <input type="password" id="admin_password" name="password" placeholder="Password" required minlength="8">
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button type="submit">Create Admin</button>
            </div>
        </form>
    </div>
</div>


<!-- Add Employee Modal -->
<div id="addEmployeeModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add Employee</h2>
            <span class="close" onclick="closeModal('addEmployeeModal')">&times;</span>
        </div>
        <form id="addEmployeeForm">
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="firstname">First Name</label>
                        <input type="text" name="firstname" placeholder="First Name" required>
                    </div>
                    <div class="form-group">
                        <label for="lastname">Last Name</label>
                        <input type="text" name="lastname" placeholder="Last Name" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="email">Email Address</label>
                        <input type="email" name="email" placeholder="Email" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="password">Password</label>
                        <input type="password" name="password" placeholder="Password" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="contact_number">Contact Number</label>
                        <input type="text" name="contact_number" placeholder="Contact Number" required>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="submit">Add Employee</button>
            </div>
        </form>
    </div>
</div>

<!-- Change Employee Status Modal -->
<div id="statusModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Change Employee Status</h2>
            <span class="close" onclick="closeModal('statusModal')">&times;</span>
        </div>
        <form id="statusForm">
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="employee_id">Employee ID</label>
                        <input type="text" name="id" placeholder="Employee ID" required>
                    </div>
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select name="is_active" required>
                            <option value="" disabled selected>Select Status</option>
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="submit">Update Status</button>
            </div>
        </form>
    </div>
</div>

<!-- Change Employee Password Modal -->
<div id="passwordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Change Employee Password</h2>
            <span class="close" onclick="closeModal('passwordModal')">&times;</span>
        </div>
        <form id="passwordForm">
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="target_employee_id">Employee ID</label>
                        <input type="text" name="target_employee_id" placeholder="Employee ID" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="new_password">New Password</label>
                        <input type="password" name="new_password" placeholder="New Password" required>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="submit">Change Password</button>
            </div>
        </form>
    </div>
</div>


<section class="maintenance-card" aria-labelledby="maintenance-title">
  <h2 id="maintenance-title">Delete Old Transactions</h2>
  <p class="muted">Preview what would be deleted before confirming. Minimum allowed value: <strong>5</strong> years.</p>

  <div class="maintenance-row" style="margin-top:0.8rem;">
    <label for="yearsToKeep">Years to keep</label>
    <input id="yearsToKeep" type="number" min="2" value="2" aria-describedby="yearsHelp" />
    <div id="yearsHelp" class="muted">Records older than <em>now − years</em> will be affected.</div>

    <div style="margin-left:auto; display:flex; gap:0.5rem;">
      <button id="previewDeleteBtn" class="btn btn-primary" type="button">Preview</button>
      <button id="openDeleteModalBtn" class="btn btn-danger" type="button" disabled>Delete</button>
    </div>
  </div>

  <div id="previewBlock" class="hidden" style="margin-top:1rem;">
    <div class="notice" role="status" aria-live="polite">
      <div id="previewMessage"><strong>Preview:</strong> Checking counts…</div>
    </div>

    <ul id="previewCounts" style="margin-top:0.6rem;">
      <li>Order rows: <span id="previewOrders">0</span></li>
      <li>Order item rows: <span id="previewOrderItems">0</span></li>
      <li>Stock transactions: <span id="previewStocks">0</span></li>
      <li>Stock item rows: <span id="previewStockItems">0</span></li>
    </ul>

    <div id="previewCutoff" class="muted" style="margin-top:0.6rem;">Cutoff date: <span id="previewCutoffDate">—</span></div>
  </div>
</section>

<!-- Confirmation Modal (hidden by default) -->
<div id="deleteConfirmModal" class="modal hidden" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
  <div class="modal-backdrop"></div>
  <div class="modal-content" role="document">
    <h3 id="confirmTitle">Confirm Delete</h3>
    <p id="confirmMessage">You are about to delete <strong id="confirmTotal">0</strong> records of transaction history.</p>

    <div style="margin-top:8px;">
      <ul>
        <li>Order rows: <strong id="confirmOrders">0</strong></li>
        <li>Order item rows: <strong id="confirmOrderItems">0</strong></li>
        <li>Stock transactions: <strong id="confirmStocks">0</strong></li>
        <li>Stock item rows: <strong id="confirmStockItems">0</strong></li>
      </ul>
    </div>

    <div id="confirmCutoff" class="muted" style="margin-top:8px;">Cutoff date: <span id="confirmCutoffDate">—</span></div>

    <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:8px;">
      <button id="cancelDeleteBtn" class="btn" type="button">Decline</button>
      <button id="confirmDeleteBtn" class="btn btn-danger" type="button">Accept</button>
    </div>
  </div>
</div>

<section class="maintenance-card" aria-labelledby="maintenance-title">
  <h2 id="maintenance-title">Audit Logs</h2>


  <!-- Table + Slider -->
  <div class="table-wrapper">
    <div class="table-container">
      <table id="auditTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Entity</th>
            <th>Entity ID</th>
            <th>Action</th>
            <th>Details</th>
            <th>User</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody id="auditBody"></tbody>
      </table>
    </div>

  </div>

  <!-- Pagination Buttons (Bottom) -->
  <div class="pagination" id="pagination"></div>
</section>


<!-- END OF TESTING HTML -->

</body>
</html>

<script>
  const notificationIcon = document.getElementById("notificationToggle");
  const dropdownMenu = document.getElementById("notificationDropdown");

  document.addEventListener("click", function (e) {
    const isInside = notificationIcon.contains(e.target) || dropdownMenu.contains(e.target);
    if (!isInside) {
      dropdownMenu.style.display = "none";
    }
  });

  notificationIcon.addEventListener("click", function (e) {
    e.stopPropagation();
    dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
  });
</script>


<script>
async function postData(url = '', data = {}) {
  const response = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  return response.json();
}

async function putData(url = '', data = {}) {
  const response = await fetch(url, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  return response.json();
}

// Add Employee
document.getElementById('addEmployeeForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = Object.fromEntries(new FormData(e.target));
  const res = await postData('/api/settings/add-employees', formData);
  alert(JSON.stringify(res));
});

// Update Status
document.getElementById('statusForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = Object.fromEntries(new FormData(e.target));
  const res = await putData(`/api/settings/${formData.id}/status`, { is_active: formData.is_active === "true" });
  alert(JSON.stringify(res));
});

// Change Password
const adminId = "{{ user.id }}"; // passed from backend via user dict

async function postData(url = '', data = {}) {
  const response = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  return response.json();
}

document.getElementById('passwordForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const formData = Object.fromEntries(new FormData(e.target));

  const payload = {
    target_employee_id: formData.target_employee_id,
    new_password: formData.new_password
  };

  const res = await postData('/api/settings/change-employee-password', payload);
  alert(JSON.stringify(res));
});

//Admin Account Creation
async function createAdmin(event) {
    event.preventDefault();

    const form = document.getElementById('addAdminForm');
    const data = {
        firstname: form.firstname.value,
        lastname: form.lastname.value,
        email: form.email.value,
        password: form.password.value
    };

    try {
        const response = await fetch('/api/admin/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const err = await response.json();
            alert(`Error: ${err.detail || response.statusText}`);
            return;
        }

        alert('✅ Admin account created successfully!');
        closeModal('addAdminModal');
        form.reset();

    } catch (error) {
        console.error(error);
        alert('An unexpected error occurred.');
    }
}


async function changeAdminPassword(event) {
    event.preventDefault();

    const currentPassword = document.getElementById('current_admin_password').value;
    const newPassword = document.getElementById('new_admin_password').value;
    const confirmPassword = document.getElementById('confirm_admin_password').value;

    if (newPassword !== confirmPassword) {
        alert("New passwords do not match!");
        return;
    }

    try {
        const formData = new FormData();
        formData.append("current_password", currentPassword);
        formData.append("new_password", newPassword);

        const response = await fetch("/api/change-password", {
            method: "POST",
            body: formData
        });

        const result = await response.json();
        alert(result.message);

        if (result.success) {
            closeModal('changeAdminPasswordModal');
            document.getElementById('changeAdminPasswordForm').reset();
        }
    } catch (error) {
        alert("An error occurred: " + error.message);
    }
}

// Migrate Hashes
document.getElementById('migrateBtn').addEventListener('click', async () => {
  const res = await postData('/api/settings/migrate-hashes', {});
  alert(JSON.stringify(res));
});
</script>

<script>
const API_BASE = '/api';

const previewUrl = years => `${API_BASE}/maintenance/preview-delete/${encodeURIComponent(years)}`;
const deleteUrl  = years => `${API_BASE}/maintenance/delete-old-transactions/${encodeURIComponent(years)}`;

async function fetchJson(url, options = {}) {
  const opts = {
    credentials: 'include',
    headers: { 'Accept': 'application/json' },
    ...options
  };
  if (opts.body && typeof opts.body === 'object' && !(opts.body instanceof FormData)) {
    opts.headers['Content-Type'] = 'application/json';
    opts.body = JSON.stringify(opts.body);
  }
  const resp = await fetch(url, opts);
  const text = await resp.text();
  let json = null;
  try { json = text ? JSON.parse(text) : null; } catch (e) { /* not json */ }
  if (!resp.ok) {
    const detail = (json && (json.detail || json.message)) || text || resp.statusText;
    const err = new Error(detail);
    err.status = resp.status;
    throw err;
  }
  return json;
}

/* UI elements */
const previewBtn = document.getElementById('previewDeleteBtn');
const deleteBtn = document.getElementById('openDeleteModalBtn');
const yearsInput = document.getElementById('yearsToKeep');

const previewBlock = document.getElementById('previewBlock');
const previewMessage = document.getElementById('previewMessage');
const previewOrders = document.getElementById('previewOrders');
const previewOrderItems = document.getElementById('previewOrderItems');
const previewStocks = document.getElementById('previewStocks');
const previewStockItems = document.getElementById('previewStockItems');
const previewCutoffDate = document.getElementById('previewCutoffDate');

const modal = document.getElementById('deleteConfirmModal');
const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

const confirmTotal = document.getElementById('confirmTotal');
const confirmOrders = document.getElementById('confirmOrders');
const confirmOrderItems = document.getElementById('confirmOrderItems');
const confirmStocks = document.getElementById('confirmStocks');
const confirmStockItems = document.getElementById('confirmStockItems');
const confirmCutoffDate = document.getElementById('confirmCutoffDate');

function showPreviewBlock() {
  previewBlock.classList.remove('hidden');
}
function hidePreviewBlock() {
  previewBlock.classList.add('hidden');
}


/* compute total helper */
function totalFromResult(res) {
  return (res.old_order_items || 0) + (res.old_orders || 0) + (res.old_stock_items || 0) + (res.old_stocks || 0);
}

/* Preview flow */
previewBtn.addEventListener('click', async () => {
  const years = Number(yearsInput.value || 0);
  if (!years || years < 2) {
    alert('Please enter a number >= 5 for years.');
    return;
  }

  // show loading state
  showPreviewBlock();
  previewMessage.textContent = 'Preview: checking counts…';
  previewOrders.textContent = previewOrderItems.textContent = previewStocks.textContent = previewStockItems.textContent = '-';
  previewCutoffDate.textContent = '—';
  deleteBtn.disabled = true;

  try {
    const res = await fetchJson(previewUrl(years), { method: 'GET' });

    if (res && res.message && (res.message.indexOf("Data still") === 0 || res.message.indexOf("Data still") !== -1)) {
      // special zero-result message from server
      previewMessage.innerHTML = `<strong>Preview:</strong> ${res.message}`;
      previewOrders.textContent = previewOrderItems.textContent = previewStocks.textContent = previewStockItems.textContent = '0';
      previewCutoffDate.textContent = res.cutoff_date || '—';
      deleteBtn.disabled = true; // nothing to delete
      return;
    }

    // Normal preview result with counts
    previewOrders.textContent = res.old_orders ?? 0;
    previewOrderItems.textContent = res.old_order_items ?? 0;
    previewStocks.textContent = res.old_stocks ?? 0;
    previewStockItems.textContent = res.old_stock_items ?? 0;
    previewCutoffDate.textContent = res.cutoff_date ?? '—';

    const total = totalFromResult(res);
    previewMessage.innerHTML = `<strong>Preview:</strong> This operation would delete <strong>${total}</strong> records.`;

    // enable Delete button only if total > 0
    deleteBtn.disabled = total === 0;

    // store the last preview response on the delete button element for use later
    deleteBtn._previewData = res;

  } catch (err) {
    console.error(err);
    previewMessage.textContent = 'Error fetching preview: ' + (err.message || 'Unknown error');
    deleteBtn.disabled = true;
  }
});

/* Open modal with preview data */
deleteBtn.addEventListener('click', (e) => {
  const data = deleteBtn._previewData;
  if (!data) return alert('Please run Preview first.');

  const total = totalFromResult(data);
  confirmTotal.textContent = total;
  confirmOrders.textContent = data.old_orders ?? 0;
  confirmOrderItems.textContent = data.old_order_items ?? 0;
  confirmStocks.textContent = data.old_stocks ?? 0;
  confirmStockItems.textContent = data.old_stock_items ?? 0;
  confirmCutoffDate.textContent = data.cutoff_date ?? '—';

  // show modal and make Accept clickable
  openModal('deleteConfirmModal');
});

/* Cancel modal */
cancelDeleteBtn.addEventListener('click', () => {
  closeModal('deleteConfirmModal');
});

/* Confirm delete (perform destructive action) */
confirmDeleteBtn.addEventListener('click', async () => {
  // disable the button once clicked to avoid double submissions
  confirmDeleteBtn.disabled = true;
  confirmDeleteBtn.textContent = 'Deleting…';

  const years = Number(yearsInput.value || 0);
  try {
    const res = await fetchJson(deleteUrl(years), { method: 'DELETE' });

    // close modal after a short delay
    setTimeout(() => {
      closeModal('deleteConfirmModal');
      confirmDeleteBtn.disabled = false;
      confirmDeleteBtn.textContent = 'Accept';
      // disable Delete button now (nothing left to delete)
      deleteBtn.disabled = true;
    }, 1200);

  window.location.reload();
  } catch (err) {
    console.error(err);
    alert('Delete failed: ' + (err.message || 'server error'));
    confirmDeleteBtn.disabled = false;
    confirmDeleteBtn.textContent = 'Accept';
  }
});

/* Make clicking the backdrop close the modal */
document.addEventListener('click', (ev) => {
  if (!modal || modal.classList.contains('hidden')) return;
  // if the click target is the backdrop, close
  const backdrop = modal.querySelector('.modal-backdrop');
  if (backdrop && backdrop.contains(ev.target)) {
    closeModal('deleteConfirmModal');
  }
});



const API = '/api/audit-logs';
const PAGE_SIZE = 10;  // 10 rows per page
let logs = [];         // full dataset loaded from server
let currentPage = 1;

const auditBody = document.getElementById('auditBody');
const paginationDiv = document.getElementById('pagination');

// fetch logs and initialize UI
async function init() {
  try {
    const resp = await fetch(`${API}?limit=1000`); // fetch many; adapt if you want server pagination
    if (!resp.ok) throw new Error('Failed to fetch audit logs: ' + resp.status);
    const json = await resp.json();
    logs = (json.logs || []).sort((a,b) => {
      // try to sort by action_time descending if present
      const ta = a.action_time || a.timestamp || '';
      const tb = b.action_time || b.timestamp || '';
      return String(tb).localeCompare(String(ta));
    });
    renderPagination();
    renderPage(1);
  } catch (err) {
    console.error(err);
    auditBody.innerHTML = `<tr><td colspan="7">Error loading logs: ${err.message}</td></tr>`;
  }
}

function renderPage(page) {
  currentPage = Math.max(1, Math.min(page, Math.ceil(logs.length / PAGE_SIZE) || 1));
  const start = (currentPage - 1) * PAGE_SIZE;
  const pageRows = logs.slice(start, start + PAGE_SIZE);

  auditBody.innerHTML = "";
  if (pageRows.length === 0) {
    auditBody.innerHTML = `<tr><td colspan="7">No audit logs</td></tr>`;
  } else {
    for (const log of pageRows) {
      const user = log.admin_id || log.employee_id || "";
      const time = log.action_time || log.timestamp || "";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${log.id ?? ""}</td>
        <td title="${escapeHtml(log.entity ?? "")}">${log.entity ?? ""}</td>
        <td title="${escapeHtml(log.entity_id ?? "")}">${log.entity_id ?? ""}</td>
        <td title="${escapeHtml(log.action ?? "")}">${log.action ?? ""}</td>
        <td title="${escapeHtml(log.details ?? "")}">${log.details ?? ""}</td>
        <td>${user}</td>
        <td>${time}</td>
      `;
      auditBody.appendChild(tr);
    }
  }

  // re-render pagination buttons
  renderPagination();

}


// pagination UI
function renderPagination() {
  const totalPages = Math.ceil(logs.length / PAGE_SIZE);
  paginationDiv.innerHTML = "";

  // Helper to make a button
  function createButton(label, page, disabled = false, bold = false) {
    const btn = document.createElement("button");
    btn.textContent = label;
    btn.disabled = disabled;
    if (bold) btn.style.fontWeight = "bold";
    btn.onclick = () => renderPage(page);
    paginationDiv.appendChild(btn);
  }

  // Prev button
  createButton("Prev", currentPage - 1, currentPage === 1);

  // Determine page numbers to display
  let pageNumbers = [];
  if (totalPages <= 7) {
    for (let i = 1; i <= totalPages; i++) pageNumbers.push(i);
  } else {
    pageNumbers.push(1);
    if (currentPage > 4) pageNumbers.push("...");
    const start = Math.max(2, currentPage - 1);
    const end = Math.min(totalPages - 1, currentPage + 1);
    for (let i = start; i <= end; i++) pageNumbers.push(i);
    if (currentPage < totalPages - 3) pageNumbers.push("...");
    pageNumbers.push(totalPages);
  }

  // Render numeric buttons
  pageNumbers.forEach(num => {
    if (num === "...") {
      const span = document.createElement("span");
      span.textContent = "...";
      span.style.margin = "0 5px";
      paginationDiv.appendChild(span);
    } else {
      createButton(num, num, num === currentPage, num === currentPage);
    }
  });

  // Next button
  createButton("Next", currentPage + 1, currentPage === totalPages);

}


// Slider <-> scroll sync
const tbodyElement = () => auditBody.parentElement; // the actual tbody element (display:block)


// helper
function escapeHtml(s) {
  if (!s) return '';
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

// Initialize when DOM ready
document.addEventListener('DOMContentLoaded', init);

/* End of maintenance JS */
</script>


<script>
    // Modal functions
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // Demo form submission handlers
    document.getElementById('addEmployeeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        alert('Employee would be added here');
        closeModal('addEmployeeModal');
    });

    document.getElementById('statusForm').addEventListener('submit', function(e) {
        e.preventDefault();
        alert('Employee status would be updated here');
        closeModal('statusModal');
    });

    document.getElementById('passwordForm').addEventListener('submit', function(e) {
        e.preventDefault();
        alert('Employee password would be changed here');
        closeModal('passwordModal');
    });

    document.getElementById('migrateBtn').addEventListener('click', function() {
        if (confirm('Are you sure you want to run the password migration? This cannot be undone.')) {
            alert('Migration would run here');
            closeModal('migrateModal');
        }
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modals = ['addEmployeeModal', 'statusModal', 'passwordModal', 'migrateModal'];
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    }
</script>
