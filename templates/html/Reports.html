<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=0.55">
  <title>Times Stock IMS</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp" rel="stylesheet">
  <link rel="stylesheet" href="../css/reports.css?v=3">
  <style>
/* ---------- MOBILE LAYOUT (max-width: 768px) ---------- */
@media screen and (max-width: 768px) {

  body, .container {
    padding: 0 1rem;
  }

  .container {
    grid-template-columns: 1fr; /* full-width layout */
    gap: 1rem;
  }

  main {
    margin-top: 1rem;
    padding: 0;
  }

  /* Header bar adjustments */
  .header-bar {
    flex-direction: column;
    align-items: flex-start;
    padding-right: 0;
    margin-bottom: 1rem;
  }

  .top-bar {
    gap: 0.5rem;
  }

  /* Form layout stacked */
  .form-row {
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }

  .form-group input {
    width: 100%;
  }

  .generate-btn {
    width: 100%;
    text-align: center;
  }

  /* Reports grid stacked vertically */
  .reports-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
  }

  /* Stats cards 1 per row */
  .summary-stats, .ma-grid {
    grid-template-columns: 1fr 1fr; /* two per row, adjust if needed */
    gap: 10px;
  }

  /* Table adjustments */
  .report-table {
    font-size: 12px;
    display: block;
    overflow-x: auto;
    width: 100%;
  }

  .report-table th, .report-table td {
    padding: 8px 6px;
    white-space: nowrap;
  }

  /* Report sections full width */
  .report-section, .report-form {
    padding: 15px;
  }

  /* Interpretation list readability */
  .interpretation-list h4 {
    font-size: 13px;
  }

  .interpretation-list p, 
  .interpretation-list li {
    font-size: 12px;
  }

  /* Empty message & error box */
  .empty-message, .error {
    font-size: 13px;
    padding: 20px;
  }

  /* Download button full width */
  .download-btn {
    width: 100%;
    padding: 12px 0;
  }
    /* Header bar same as other tabs */
  .header-bar {
    flex-direction: row;           /* horizontal layout */
    justify-content: space-between; /* space between greeting and top-bar */
    align-items: center;           /* vertical alignment */
    width: 100%;
    margin-bottom: 1rem;
    padding: 0 1rem;               /* similar padding as other tabs */
  }

  /* Top-bar spacing */
  .top-bar {
    gap: 0.5rem;                   /* small gap between elements */
    flex-wrap: wrap;                /* allow wrapping if needed */
  }
}

  </style>
</head>
<body>
  <div class="container">
    <aside>
      <div class="top">
        <div class="logo">
          <img src="../images/TIMESTOCK_BG.png">
        </div>
      <h2>TIME<span class="danger">STOCK</span></h2>

    </div>
    <div class="mobile-menu-btn">
      <span class="material-symbols-sharp">menu</span>
    </div>
       {% include "sidebar.html" %}
</aside>
<!-----END OF ASIDE MUENU----->
<main>
  <div class="header-bar">
  <h1>Reports</h1>
  <div class="top-bar">
        {% include 'alert.html' %}
   {% include "profile.html" %}
  </div>
</div>

<div class="report-container">
  <!-- Report Generation Form -->
  <div class="report-form">
    <h2>üìä Generate Reports</h2>
    <form method="get" action="/Reports.html">
      <div class="form-row">
        <div class="form-group">
          <label for="year">Year:</label>
          <input type="number" name="year" id="year" min="2010" max="2100" required>
        </div>
        
        <div class="form-group">
          <label for="month">Month:</label>
          <input type="number" name="month" id="month" min="1" max="12" required>
        </div>
        
        <div class="form-group">
          <button type="submit" class="generate-btn">Generate Report</button>
        </div>
      </div>
    </form>
  </div>

  <div class="reports-grid">
    <!-- Sales Report -->
    {% if report_text and not report_text.empty %}
    <div class="report-section">
      <div class="report-header">
        <h3>üìà {{ report_text.title }}</h3>
      </div>
      <div class="report-content">
        <div class="summary-stats">
          <div class="stat-card">
            <div class="stat-label">Total Orders</div>
            <div class="stat-value">{{ report_text.total_orders }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Sales</div>
            <div class="stat-value">{{ report_text.total_sales }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Revenue</div>
            <div class="stat-value">‚Ç±{{ "{:,.2f}".format((report_text.total_revenue))}}</div>
          </div>
        </div>

        <h4 style="font-size: 14px; margin-bottom: 10px; font-weight: 600;">üìÖ Daily Breakdown</h4>
        <div style="max-height: 200px; overflow-y: auto;">
          <table class="report-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Orders</th>
                <th>Sales</th>
                <th>Revenue</th>
              </tr>
            </thead>
            <tbody>
              {% for row in report_text.breakdown %}
              <tr>
                <td>{{ row.day }}</td>
                <td>{{ row.orders }}</td>
                <td>{{ row.sales }}</td>
                <td class="revenue-cell">‚Ç±{{ "{:,.2f}".format(row.revenue) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% elif report_text and report_text.empty %}
    <div class="report-section">
      <div class="empty-message">{{ report_text.message }}</div>
    </div>
    {% endif %}

    <!-- Turnover Report -->
    {% if turnover_report and not turnover_report.empty %}
    <div class="report-section">
      <div class="report-header">
        <h3>üîÑ {{ turnover_report.title }}</h3>
      </div>
      <div class="report-content">
        <div class="summary-stats">
          <div class="stat-card">
            <div class="stat-label">COGS</div>
            <div class="stat-value">‚Ç±{{ "{:,.2f}".format(turnover_report.cogs) }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Avg Inventory</div>
            <div class="stat-value">‚Ç±{{ "{:,.2f}".format(turnover_report.avg_inventory) }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Turnover Rate</div>
            <div class="stat-value">{{ "%.2f"|format(turnover_report.turnover_rate) }}x</div>
          </div>
        </div>
        
        <div class="interpretation-list">
          <h4>üìã Analysis</h4>
          <p><em>{{ turnover_report.interpretation }}</em></p>
        </div>
      </div>
    </div>
    {% elif turnover_report and turnover_report.empty %}
    <div class="report-section">
      <div class="empty-message">{{ turnover_report.message }}</div>
    </div>
    {% endif %}

    <!-- STL Report -->
    {% if stl_report and not stl_report.empty %}
    <div class="report-section">
      <div class="report-header">
        <h3>üìä {{ stl_report.title }}</h3>
      </div>
      <div class="report-content">
        <div class="summary-stats">
          <div class="stat-card">
            <div class="stat-label">Top Product</div>
            <div class="stat-value" style="font-size: 14px;">{{ stl_report.top_product }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Trend</div>
            <div class="stat-value">{{ "%.2f"|format(stl_report.trend) }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Seasonal</div>
            <div class="stat-value">{{ "%.2f"|format(stl_report.seasonal) }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Residual</div>
            <div class="stat-value">{{ "%.2f"|format(stl_report.residual) }}</div>
          </div>
        </div>

        <div class="interpretation-list">
          <h4>üìã Interpretation</h4>
          <ul>
            {% for interp in stl_report.interpretations %}
              <li>{{ interp }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    {% elif stl_report and stl_report.empty %}
    <div class="report-section">
      <div class="empty-message">{{ stl_report.message }}</div>
    </div>
    {% endif %}

    <!-- Moving Average Report -->
    {% if moving_avg_report and not moving_avg_report.empty %}
    <div class="report-section">
      <div class="report-header">
        <h3>üìà {{ moving_avg_report.title }}</h3>
      </div>
      <div class="report-content">
        <div class="summary-stats">
          <div class="stat-card">
            <div class="stat-label">Total Sales</div>
            <div class="stat-value">‚Ç±{{ "{:,.2f}".format(moving_avg_report.total_sales) }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Top Product</div>
            <div class="stat-value" style="font-size: 14px;">{{ moving_avg_report.top_product }}</div>
          </div>
        </div>

        <div class="ma-grid">
          <div class="ma-card">
            <div class="ma-label">3-Month Moving Avg</div>
            <div class="ma-value">
              {% if moving_avg_report.ma3 is not none %}
                ‚Ç±{{ "{:,.2f}".format(moving_avg_report.ma3) }}
              {% else %}
                <em>Not enough data</em>
              {% endif %}
            </div>
          </div>
          <div class="ma-card">
            <div class="ma-label">6-Month Moving Avg</div>
            <div class="ma-value">
              {% if moving_avg_report.ma6 is not none %}
                ‚Ç±{{ "{:,.2f}".format(moving_avg_report.ma6) }}
              {% else %}
                <em>Not enough data</em>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
    {% elif moving_avg_report and moving_avg_report.empty %}
    <div class="report-section">
      <div class="empty-message">{{ moving_avg_report.message }}</div>
    </div>
    {% endif %}

    <!-- Stock Movement Report -->
    {% if stock_movement_report and not stock_movement_report.empty %}
    <div class="report-section full-width">
      <div class="report-header">
        <h3>üì¶ {{ stock_movement_report.title }}</h3>
      </div>
      <div class="report-content">
        <div class="summary-stats">
          <div class="stat-card">
            <div class="stat-label">Stock-In Events</div>
            <div class="stat-value">{{ stock_movement_report.total_stock_in_events }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Stock-Out Events</div>
            <div class="stat-value">{{ stock_movement_report.total_stock_out_events }}</div>
          </div>
        </div>

        <h4 style="font-size: 14px; margin-bottom: 10px; font-weight: 600;">üìã Material Breakdown</h4>
        <div style="max-height: 180px; overflow-y: auto;">
          <table class="report-table">
            <thead>
              <tr>
                <th>Material</th>
                <th>Stock-In Events</th>
                <th>Stock-Out Events</th>
              </tr>
            </thead>
            <tbody>
              {% for row in stock_movement_report.breakdown %}
              <tr>
                <td>{{ row.material_name }}</td>
                <td>{{ row.stock_in_events }}</td>
                <td>{{ row.stock_out_events }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% elif stock_movement_report and stock_movement_report.empty %}
    <div class="report-section">
      <div class="empty-message">{{ stock_movement_report.message }}</div>
    </div>
    {% endif %}

    <!-- Products Sold Report -->
    {% if products_sold_report and not products_sold_report.empty %}
    <div class="report-section full-width">
      <div class="report-header">
        <h3>üõçÔ∏è {{ products_sold_report.title }}</h3>
      </div>
      <div class="report-content">
        <div class="summary-stats">
          <div class="stat-card">
            <div class="stat-label">Total Quantity</div>
            <div class="stat-value">{{ products_sold_report.total_quantity_all }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Sales</div>
            <div class="stat-value">‚Ç±{{ "{:,.2f}".format(products_sold_report.total_sales_all) }}</div>
          </div>
        </div>

        <h4 style="font-size: 14px; margin-bottom: 10px; font-weight: 600;">üìã Product Breakdown</h4>
        <div style="max-height: 180px; overflow-y: auto;">
          <table class="report-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Quantity Sold</th>
                <th>Total Sales</th>
              </tr>
            </thead>
            <tbody>
              {% for row in products_sold_report.breakdown %}
              <tr>
                <td>{{ row.product_name }}</td>
                <td>{{ row.total_quantity }}</td>
                <td class="revenue-cell">‚Ç±{{ "{:,.2f}".format(row.total_sales) }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% elif products_sold_report and products_sold_report.empty %}
    <div class="report-section">
      <div class="empty-message">{{ products_sold_report.message }}</div>
    </div>
    {% endif %}
  </div>

  {% if error_message %}
  <p class="error">{{ error_message }}</p>
  {% endif %}

  <!-- Download Section -->
  <div class="download-section">
    <button id="downloadPdfBtn" class="download-btn">üìÑ Download PDF Report</button>
  </div>
</div>


  </div>
</body>
</html>
<script>
  const notificationIcon = document.getElementById("notificationToggle");
  const dropdownMenu = document.getElementById("notificationDropdown");

  document.addEventListener("click", function (e) {
    const isInside = notificationIcon.contains(e.target) || dropdownMenu.contains(e.target);
    if (!isInside) {
      dropdownMenu.style.display = "none";
    }
  });

  notificationIcon.addEventListener("click", function (e) {
    e.stopPropagation();
    dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
  });
</script>

<script>
document.getElementById("downloadPdfBtn").addEventListener("click", function () {
  const urlParams = new URLSearchParams(window.location.search);
  let year = urlParams.get("year");
  let month = urlParams.get("month");

  // Fallback to template defaults if not in URL
  if (!year) {
    year = "{{ year }}";
  }
  if (!month) {
    month = "{{ month }}";
  }

  // Still validate year just in case
  if (!year) {
    alert("Please select a year before downloading the report.");
    return;
  }

  // Build API URL
  let apiUrl = `/api/reports/pdf?year=${year}`;
  if (month) {
    apiUrl += `&month=${month}`;
  }

  // Trigger PDF download
  window.location.href = apiUrl;
});

</script>