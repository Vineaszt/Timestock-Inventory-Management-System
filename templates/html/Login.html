<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>TIMESTOCK IMS - Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
     <link rel="stylesheet" href="../css/Login.css?v=2">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <style>
     
    </style>
</head>
<body>
    <div class="bg-animation" id="bgAnimation"></div>
    
    <div class="main-container animate-in">
        <!-- Welcome Section (Left Side) -->
        <div class="welcome-section">
            <div class="welcome-content">
                <h3>Welcome to TIMESTOCK IMS</h3>
                <p>
                    Enhance your projects with precision-crafted glass and aluminum solutions.
                    Seamlessly manage orders, track inventory, and collaborate in real-time all in one integrated system.
                    Sign in to experience smarter, faster, and more reliable manufacturing management.
                </p>
                
                <div class="feature-highlights">
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-boxes"></i>
                        </div>
                        <div class="feature-text">Real-time inventory tracking</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="feature-text">Advanced analytics & reporting</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="feature-text">Seamless team collaboration</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Login Section (Right Side) -->
        <div class="login-section">
            <div class="header">
                <div class="logo-container">
                    <div class="logo">
                        <img src="../images/TIMESTOCK_background.png" alt="TIMESTOCK Logo" class="logo-image" id="companyLogo">
                        <div class="logo-placeholder" id="logoPlaceholder" style="display: none;">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                </div>
                <h1>TIMESTOCK IMS</h1>
                <p>Secure Dashboard Access</p>
            </div>
             
          <form class="sign-in-form" method="post" action="/login">

    <div class="form-container">
        <div class="form-tabs">
            <div class="tab active" data-tab="login">Sign In</div>
            <div class="tab" data-tab="forgot">Forgot Password</div>
        </div>
        
        <div class="form-content" id="loginForm">
            <h2>Sign In to Your Account</h2>
            <p class="subtitle">Welcome back! Please enter your details</p>
            
            <!-- Removed nested <form> (not allowed inside a form) -->
            <div id="loginFormElement">
                <div class="input-group">
                    <label class="input-label">Select your name</label>
                    <div class="input-wrapper">
                        <i class="fas fa-user input-icon"></i>

                        <!-- This is new again -->
                        <!-- Role toggle (Admin / Employee) -->
                        <div class="input-group role-toggle-group">
                            <label class="input-label">Sign in as</label>
                            <div class="input-wrapper role-toggle" style="display:flex; gap:8px;">
                                <button type="button" id="roleEmployee" class="role-btn active" data-role="employee">Employee</button>
                                <button type="button" id="roleAdmin" class="role-btn" data-role="admin">Admin</button>
                            </div>
                        </div>

                        <!-- Hidden input to submit role -->
                        <input type="hidden" id="selectedRole" name="role" value="employee">
                        <!-- End of a newer code -->

                        <!-- Searchable select (Choices.js will transform it). name="user_id" sends selected id. -->
                        <select id="userSelect" name="user_id" class="input-field" required>
                            <!-- choices will be injected dynamically -->
                        </select>

                        <!-- Optional hidden fallback email input (kept but hidden) - only used if user wants to enter email manually -->
                        <input type="email" id="fallbackEmail" name="email" placeholder="Enter your email"
                            style="display:none;" class="input-field" >
                    </div>   
                    <div class="validation-message" id="userSelectValidation"></div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">Password</label>
                    <div class="input-wrapper">
                        <i class="fas fa-lock input-icon"></i>
                        <div class="password-container">
                            <!-- âœ… added name="password" -->
                            <input type="password" class="input-field" id="loginPassword" 
                                   name="password" placeholder="Enter your password" required>
                            <button type="button" class="toggle-password" id="toggleLoginPassword">
                                <i class="fas fa-eye-slash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="validation-message" id="passwordValidation"></div>
                </div>
                
                <div class="options">
                    <div class="remember-me">
                        <input type="checkbox" id="rememberMe" name="rememberMe">
                        <label for="rememberMe">Remember device</label>
                    </div>
                    <a class="forgot-password" id="forgotPasswordLink">Forgot Password?</a>
                </div>
                
                <button type="submit" class="btn" id="loginBtn">LogIn</button>
                
                {% if error %}
                    <p style="color:red;">{{ error }}</p>
                {% endif %}
            </div>
</form>

                        </button>
                        
                        <div class="security-features">
                            <div class="security-badge">
                                <i class="fas fa-shield-alt"></i>
                                <span>256-bit SSL</span>
                            </div>
                            <div class="security-badge">
                                <i class="fas fa-lock"></i>
                                <span>Encrypted</span>
                            </div>
                            <div class="security-badge">
                                <i class="fas fa-user-shield"></i>
                                <span>Secure</span>
                            </div>
                        </div>
                        
                        <div class="two-factor-hint">
                            Having trouble? <a href="#" style="color: var(--primary-blue);">Enable 2FA</a>
                        </div>
                    </form>
                </div>
                
                <div class="form-content" id="forgotForm" style="display: none;">
                    <h2>Reset Your Password</h2>
                    <p class="subtitle">Enter your email address and we'll send you a link to reset your password</p>
                    
                    <form id="forgotFormElement">
                        <div class="input-group">
                            <label class="input-label">Email Address</label>
                            <div class="input-wrapper">
                                <i class="fas fa-envelope input-icon"></i>
                                <input type="email" class="input-field" id="forgotEmail" placeholder="Enter your email address" required>
                            </div>
                            <div class="validation-message" id="forgotEmailValidation"></div>
                        </div>
                        
                        <button type="submit" class="btn" id="forgotBtn">
                            <span>Send Reset Link</span>
                        </button>
                        
                        <div class="security-features">
                            <div class="security-badge">
                                <i class="fas fa-clock"></i>
                                <span>Link expires in 1 hour</span>
                            </div>
                            <div class="security-badge">
                                <i class="fas fa-envelope"></i>
                                <span>Check spam folder</span>
                            </div>
                            <div class="security-badge">
                                <i class="fas fa-shield-alt"></i>
                                <span>Secure reset</span>
                            </div>
                        </div>
                    </form>
                    
                    <div class="back-to-login">
                        Remember your password? <a href="#" id="backToLogin">Sign in here</a>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <!-- <script>
        // Logo image fallback
        const logoImage = document.getElementById('companyLogo');
        const logoPlaceholder = document.getElementById('logoPlaceholder');
        
        logoImage.addEventListener('error', function() {
            this.style.display = 'none';
            logoPlaceholder.style.display = 'flex';
        });

        logoImage.addEventListener('load', function() {
            this.style.display = 'block';
            logoPlaceholder.style.display = 'none';
        });

        // Tab switching
        const tabs = document.querySelectorAll('.tab');
        const loginForm = document.getElementById('loginForm');
        const forgotForm = document.getElementById('forgotForm');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const tabType = tab.dataset.tab;
                if (tabType === 'login') {
                    loginForm.style.display = 'block';
                    forgotForm.style.display = 'none';
                } else {
                    loginForm.style.display = 'none';
                    forgotForm.style.display = 'block';
                }
            });
        });

        // Form switching links
        document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelector('[data-tab="forgot"]').click();
        });

        document.getElementById('backToLogin').addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelector('[data-tab="login"]').click();
        });

        // Password toggle functionality
        function setupPasswordToggle(passwordId, toggleId) {
            const password = document.getElementById(passwordId);
            const toggle = document.getElementById(toggleId);
            const icon = toggle.querySelector('i');

            toggle.addEventListener('click', () => {
                const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
                password.setAttribute('type', type);
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
                password.focus();
            });
        }

        setupPasswordToggle('loginPassword', 'toggleLoginPassword');

       

        // Real-time validation for forgot password email
        document.getElementById('forgotEmail').addEventListener('input', function() {
            const email = this.value;
            const validation = document.getElementById('forgotEmailValidation');
            
            if (email && !validateEmail(email)) {
                validation.textContent = 'Please enter a valid email address';
                validation.className = 'validation-message error';
                this.classList.add('error');
            } else {
                validation.textContent = '';
                this.classList.remove('error');
                if (email) this.classList.add('success');
            }
        });

        // Form submission with loading states
        function handleFormSubmission(formId, buttonId, successMessage) {
            const form = document.getElementById(formId);
            const button = document.getElementById(buttonId);

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Basic validation
                let isValid = true;
                const inputs = form.querySelectorAll('.input-field[required]');
                
                inputs.forEach(input => {
                    if (!input.value.trim()) {
                        input.classList.add('error');
                        isValid = false;
                    } else {
                        input.classList.remove('error');
                        input.classList.add('success');
                    }
                });

                if (!isValid) return;

                // Show loading state
                button.classList.add('btn-loading');
                button.disabled = true;

                // Simulate API call
                setTimeout(() => {
                    button.classList.remove('btn-loading');
                    button.disabled = false;
                    
                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.className = 'validation-message success';
                    successDiv.textContent = successMessage;
                    successDiv.style.textAlign = 'center';
                    successDiv.style.marginTop = '16px';
                    successDiv.style.fontSize = '14px';
                    
                    form.appendChild(successDiv);
                    
                    // Remove success message after 3 seconds
                    setTimeout(() => {
                        successDiv.remove();
                        form.reset();
                        inputs.forEach(input => {
                            input.classList.remove('success', 'error');
                        });
                    }, 3000);
                    
                }, 2000);
            });
        }

        handleFormSubmission('loginFormElement', 'loginBtn', 'Login successful! Redirecting...');
        handleFormSubmission('forgotFormElement', 'forgotBtn', 'Reset link sent to your email!');

        // Add smooth scroll behavior
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        // Add keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Tab' && e.shiftKey) {
                // Handle shift+tab navigation
                const focusableElements = document.querySelectorAll('input, button, [tabindex]:not([tabindex="-1"])');
                // Custom tab handling if needed
            }
        });
    </script> -->
<script>
/* Helpers */
function debounce(fn, wait){
  let t;
  return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
}

/* Role-aware fetch */
async function fetchUsersByRole(role='employee', q='') {
  role = role || 'employee';
  const qParam = q && q.length >= 2 ? `&q=${encodeURIComponent(q)}` : '';
  try {
    const res = await fetch(`/api/users/list?role=${encodeURIComponent(role)}${qParam}`);
    if (!res.ok) return [];
    return await res.json(); // expects [{id, display_name}, ...]
  } catch (err) {
    console.error("fetchUsersByRole failed", err);
    return [];
  }
}

/* Setup Choices (existing options kept) */
const userSelectEl = document.getElementById('userSelect');
const choices = new Choices(userSelectEl, {
  searchEnabled: true,
  shouldSort: false,
  placeholder: true,
  placeholderValue: 'Pick your name...',
  searchPlaceholderValue: 'Type at least 2 characters...',
  itemSelectText: '',
  maxItemCount: 1,
  removeItems: false,
  noResultsText: 'No users found',
  loadingText: 'Loading...'
});

/* Role toggle logic */
const roleEmployeeBtn = document.getElementById('roleEmployee');
const roleAdminBtn = document.getElementById('roleAdmin');
const selectedRoleInput = document.getElementById('selectedRole');

let currentRole = selectedRoleInput.value || 'employee';

function setRole(role) {
  currentRole = role;
  selectedRoleInput.value = role;
  if (role === 'admin') {
    roleAdminBtn.classList.add('active');
    roleEmployeeBtn.classList.remove('active');
  } else {
    roleEmployeeBtn.classList.add('active');
    roleAdminBtn.classList.remove('active');
  }
  // clear previous selection and refresh choices for new role
  choices.clearStore();
  choices.removeActiveItems();
  refreshChoicesForRole(role);
}

roleEmployeeBtn.addEventListener('click', () => setRole('employee'));
roleAdminBtn.addEventListener('click', () => setRole('admin'));

/* Populate initial choices for currentRole */
async function refreshChoicesForRole(role) {
  const users = await fetchUsersByRole(role, ""); // empty returns small list (limit) if server does
  const mapped = users.map(u => ({ value: String(u.id), label: u.display_name }));
  choices.setChoices(mapped, 'value', 'label', true);
}

(async () => { await refreshChoicesForRole(currentRole); })();

/* Debounced search: call backend when user types (>=2 chars) */
userSelectEl.addEventListener('search', debounce(async function(e) {
  const q = e.detail.value || '';
  if (q.length < 2) return;
  const results = await fetchUsersByRole(currentRole, q);
  const mapped = results.map(u => ({ value: String(u.id), label: u.display_name }));
  choices.setChoices(mapped, 'value', 'label', true);
}, 300));

/* Ensure form submission still validates selection and password */
(function setupLoginSubmission() {
  const loginForm = document.querySelector('.sign-in-form');
  const loginBtn = document.getElementById('loginBtn');

  loginForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const selectedValue = userSelectEl.value;
    const passwordInput = document.getElementById('loginPassword');

    if (!selectedValue) {
      document.getElementById('userSelectValidation').textContent = 'Please pick your name or enter email';
      document.getElementById('fallbackEmail').style.display = 'block';
      return;
    } else {
      document.getElementById('userSelectValidation').textContent = '';
    }

    if (!passwordInput.value.trim()) {
      document.getElementById('passwordValidation').textContent = 'Password is required';
      passwordInput.classList.add('error');
      return;
    } else {
      document.getElementById('passwordValidation').textContent = '';
      passwordInput.classList.remove('error');
    }

    loginBtn.disabled = true;
    loginBtn.classList.add('btn-loading');

    try { localStorage.setItem('lastUserId', selectedValue); } catch (_) {}

    // submit the form so /login receives user_id and role
    loginForm.submit();
  });
})();
</script>


</body>
</html>