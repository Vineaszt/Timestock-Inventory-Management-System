<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=0.55">
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Times Stock IMS</title>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp" rel="stylesheet">
  <link rel="stylesheet" href="../css/Materials.css?v=7">
<<<<<<< HEAD
<style> 
=======
<style>
>>>>>>> 998790e18aa343458a92ca046fa99446a4bb0913
/* ---------- MOBILE LAYOUT ---------- */
@media screen and (max-width: 768px) {

  /* ---------- CONTAINERS ---------- */
  .container, main, header, .header-bar {
    width: 1000px;    
    margin: 0 auto;
    box-sizing: border-box;
  }

  .container {
    display: block;
    padding: 0;
  }

  main {
    margin: 0 auto;
    padding: 1rem 1rem 2rem 1rem;
  }

  /* ---------- BURGER BUTTON ---------- */
  .mobile-menu-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border: none;
    cursor: pointer;
    position: fixed;
    top: 0.8rem;
    left: 1rem;
    z-index: 300;
    width: 3rem;
    height: 3rem;
    border-radius: 0.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .mobile-menu-btn span {
    font-size: 2rem;
    color: var(--color-primary);
  }

  /* ---------- HEADER AREA ---------- */
  .top {
    padding-left: 3.8rem;
  }

  .header-bar h1,
  .header-bar h2 {
    font-size: 1.2rem;
  }

  /* ---------- SUMMARY CARDS ---------- */
  #summary-cards,
  .insights,
  .cards-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
    width: 100%;
    margin-top: 1rem;
  }

  #summary-cards > div,
  .insights > div,
  .summary-card {
    width: 100%;
    padding: 1rem;
    font-size: 1rem;
  }

  /* ---------- CRUD & MODAL BUTTONS ---------- */
  .crud-buttons,
  .modal-actions {
    display: flex;
    flex-wrap: nowrap;       /* single row */
    gap: 0.5rem;             /* spacing between buttons */
    justify-content: space-between;
  }

  .crud-buttons button,
  .modal-actions button {
    flex: 1 1 0;             /* stretch evenly */
    text-align: center;
    min-width: 0;
    padding: 0.8rem 0;       /* tap-friendly height */
    font-size: 0.95rem;
  }

  /* ---------- FILTER BAR ---------- */
  .filters {
    flex-direction: column;
    align-items: stretch;
  }

  .filter-group,
  .range-group .range-inputs {
    width: 100%;
    flex-wrap: nowrap;
  }

  .range-group input {
    flex: 1;
  }

  /* ---------- TABLE ---------- */
  .table-scroll {
    height: calc(100vh - 250px); /* adjust for header + filters */
  }

  #productTable th:last-child,
  #productTable td:last-child {
    min-width: 140px;   /* ensures buttons fit */
    white-space: nowrap;
  }

  .action-buttons {
    flex-wrap: nowrap;
    gap: 0.5rem;
  }

  .action-buttons button {
    flex: 1 1 0;
    min-width: 0;
  }

  /* ---------- MODALS ---------- */
  .modal-content,
  #productMaterialModal .modal-box {
    width: 95%;
    max-width: 95%;
    margin: 5% auto;
    padding: 20px;
  }

  .form-grid {
    grid-template-columns: 1fr; /* stack form fields */
    gap: 12px;
  }

  .stock-info-grid {
    grid-template-columns: 1fr;
    gap: 10px;
  }
}
</style>

</style>
</head>
<body>
  <div class="container">
    <aside>
      <div class="top">
        <div class="logo">
          <img src="../images/TIMESTOCK_BG.png">
        </div>
            <h2>TIME<span class="danger">STOCK</span></h2>

    </div>
  <div class="mobile-menu-btn">
  <span class="material-symbols-sharp">menu</span>
</div>
       {% include "sidebar.html" %}
</aside>
<!-----END OF ASIDE MUENU----->
<main>
  <div class="header-bar">
  <h1>Materials Management</h1>
 <div class="top-bar">
        {% include 'alert.html' %}
        {% include "profile.html" %}
  </div>
</div>

   <div class="row" id="summary-cards">
  <!-- Card 1 -->
  <div class="col-lg-4 col-md-6 mb-3 d-flex">
    <div class="card total-unique-materials flex-fill p-4 shadow-sm d-flex flex-column">
      <div class="middle flex-grow-1 d-flex flex-column">
        <div class="left flex-grow-1">
          <h3>Total Materials</h3>
          <h1 id="total-materials" class="mt-auto">Loading...</h1>
        </div>
      </div>
      <small class="text-muted mt-2">Number of Materials Used</small>
    </div>
  </div>

  <!-- Card 2 -->
  <div class="col-lg-4 col-md-6 mb-3 d-flex">
    <div class="card top-most-used-material flex-fill p-4 shadow-sm d-flex flex-column">
      <div class="middle flex-grow-1 d-flex flex-column">
        <div class="left flex-grow-1">
          <h3>Most Used Material</h3>
          <div class="inline-pair align-items-center">
            <h1 id="most-used-material" class="mb-0">Loading...</h1>
            <h1 id="top-material-count" class="text-muted mb-0 ms-3">-</h1>
          </div>
        </div>
      </div>
      <small class="text-muted mt-2">Material Consumption By Piece</small>
    </div>
  </div>

  <!-- Card 3 -->
  <div class="col-lg-4 col-md-6 mb-3 d-flex">
    <div class="card total-material-in-stock flex-fill p-4 shadow-sm d-flex flex-column">
      <div class="middle flex-grow-1 d-flex flex-column">
        <div class="left flex-grow-1">
          <h3>Total Materials In-Stock</h3>
          <h1 id="total-material-quantity" class="mt-auto">Loading...</h1>
        </div>
      </div>
      <small class="text-muted mt-2">Total Number of Stock</small>
    </div>
  </div>
</div>

<!--------END OF THE OUT OF STOCKS---------->


<div class="products-header">
<div class="Products">
  <h2>Materials Inventory</h2>
  <!-- Buttons -->

<div class="crud-buttons">
  {% if request.session['user']['role'] == 'admin' %}
  <button class="create-btn" onclick="openModal('createModal')">Add Materials</button>
  <button class="prodMats-btn" onclick="openAddProductMaterialModal()">Add Product Materials</button>

  {% endif %}
  <button class="stocking-btn" onclick="openModal('stockMaterialsModal')">Bulk Stock Materials</button>
</div>

<div id="productMaterialModal" class="modal" style="display:none;">
  <div class="modal-box">
    <h2>Add Materials to Product</h2>

    <label for="productSelect">Select Product:</label>
    <select id="productSelect">
      <option value="">-- Select Product --</option>
    </select>

    <div id="materialsContainer"></div>

    <button onclick="addMaterialField()">+ Add Material</button>
    <br><br>
    <strong>Total Estimated Cost: ‚Ç±<span id="totalCost">0.00</span></strong>
    <br><br>
    <button onclick="submitProductMaterials()">Submit</button>
    <button onclick="closePMModal()">Cancel</button>
  </div>
</div>


<div id="stockMaterialsModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal('stockMaterialsModal')">&times;</span>
    <h2>Stock Materials</h2>

    <form id="stockMaterialsForm" onsubmit="submitStockMaterials(event)">

       <h4>Materials:</h4>
      <div id="materialsList"></div>
      <button type="button" onclick="addMaterialInput()">Add Materials</button>

      <label>Supplier:</label>
      <select id="supplierId">
        <option value="">Supplier</option>
      </select>

      <button type="button" id="toggleSupplierBtn" onclick="toggleSupplierForm()">Add New Supplier</button>


      <div id="newSupplierFields" style="display: none;">
        <fieldset>
          <legend>New Supplier</legend>
          <input type="text" id="supplierFirstname" placeholder="First Name">
          <input type="text" id="supplierLastname" placeholder="Last Name">
          <input type="text" id="supplierContactName" placeholder="Contact Name">
          <input type="text" id="supplierContactNumber" placeholder="Contact Number">
          <input type="email" id="supplierEmail" placeholder="Email">
          <input type="text" id="supplierAddress" placeholder="Address">
        </fieldset>
      </div>

      <button type="submit" class="btn btn-success mt-3">Submit</button>
    </form>
  </div>
</div>


<!-- Create Modal -->
<div id="createModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Materials</h3>
            <span class="close" onclick="closeModal('createModal')">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label for="createDate">Date</label>
                    <input type="date" id="createDate" readonly>
                </div>
                <div class="form-group full-width">
                    <label for="createItemName">Item Name</label>
                    <input type="text" id="createItemName" placeholder="Enter item name" required>
                </div>
                <div class="form-group full-width">
                    <label for="createDescription">Item Description</label>
                    <input type="text" id="createDescription" placeholder="Enter item description" required>
                </div>
                <div class="form-group">
                    <label for="createSupplier">Supplier</label>
                    <select id="createSupplier">
                        <option value="" disabled selected>Select a supplier</option>
                        <option value="supplier1">Supplier 1</option>
                        <option value="supplier2">Supplier 2</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="createCategory">Category</label>
                    <select id="createCategory">
                        <option value="" disabled selected>Select a category</option>
                        <option value="raw-materials">Raw Materials</option>
                        <option value="packaging">Packaging</option>
                        <option value="supplies">Supplies</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="createUnitMeasurement">Unit Measurement</label>
                    <select id="createUnitMeasurement">
                        <option value="ft">ft (Feet)</option>
                        <option value="sqft">sqft (Square Feet)</option>
                        <option value="pcs">pcs (Pieces)</option>
                        <option value="m">m (Meters)</option>
                        <option value="cm">cm (Centimeters)</option>
                        <option value="mm">mm (Millimeters)</option>
                        <option value="sqm">sqm (Square Meters)</option>
                    </select>
                </div>
<<<<<<< HEAD
                <div class="form-group" id="unitCostContainer">
                    <label for="createUnitCost">Unit Cost (‚Ç±)</label>
                    <input type="number" id="createUnitCost" placeholder="0.00" step="0.01" min="0" step="any" required>
=======
                <div class="form-group">
                    <label for="createUnitCost">Unit Cost (‚Ç±)</label>
                    <input type="number" id="createUnitCost" placeholder="0.00" step="0.01" min="0" required>
>>>>>>> 998790e18aa343458a92ca046fa99446a4bb0913
                </div>
                <div class="form-group">
                    <label for="createQuantity">Quantity</label>
                    <input type="number" id="createQuantity" placeholder="Enter quantity" min="0" required>
                </div>
                <div class="form-group">
                    <label for="createMinStock">Minimum Stock</label>
                    <input type="number" id="createMinStock" placeholder="Min stock level" min="0" required>
                </div>
                <div class="form-group">
                    <label for="createMaxStock">Maximum Stock</label>
                    <input type="number" id="createMaxStock" placeholder="Max stock level" min="0" required>
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button class="create-btn-modal" onclick="addMaterial()">Submit</button>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Material</h3>
            <span class="close" onclick="closeModal('editModal')">&times;</span>
        </div>
<<<<<<< HEAD

        <div class="modal-body">
            <input type="hidden" id="editMaterialId">

            <div class="form-grid">

=======
        <div class="modal-body">
            <input type="hidden" id="editMaterialId">
            <div class="form-grid">
>>>>>>> 998790e18aa343458a92ca046fa99446a4bb0913
                <div class="form-group full-width">
                    <label for="editItemName">Item Name</label>
                    <input type="text" id="editItemName" placeholder="Item Name" required>
                </div>
<<<<<<< HEAD

=======
>>>>>>> 998790e18aa343458a92ca046fa99446a4bb0913
                <div class="form-group full-width">
                    <label for="editItemDescription">Description</label>
                    <input type="text" id="editItemDescription" placeholder="Description" required>
                </div>
<<<<<<< HEAD

                <div class="form-group">
                    <label for="editCategory">Category</label>
                    <select id="editCategory"></select>
                </div>

                <div class="form-group">
                    <label for="editSupplier">Supplier</label>
                    <select id="editSupplier"></select>
                </div>

=======
                <div class="form-group">
                    <label for="editCategory">Category</label>
                    <select id="editCategory">
                        <option value="raw-materials">Raw Materials</option>
                        <option value="packaging">Packaging</option>
                        <option value="supplies">Supplies</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editSupplier">Supplier</label>
                    <select id="editSupplier">
                        <option value="supplier1">Supplier 1</option>
                        <option value="supplier2">Supplier 2</option>
                    </select>
                </div>
>>>>>>> 998790e18aa343458a92ca046fa99446a4bb0913
                <div class="form-group">
                    <label for="editUnitMeasurement">Unit Measurement</label>
                    <select id="editUnitMeasurement">
                        <option value="ft">ft (Feet)</option>
                        <option value="sqft">sqft (Square Feet)</option>
                        <option value="pcs">pcs (Pieces)</option>
                        <option value="m">m (Meters)</option>
                        <option value="cm">cm (Centimeters)</option>
                        <option value="mm">mm (Millimeters)</option>
                        <option value="sqm">sqm (Square Meters)</option>
                    </select>
                </div>
<<<<<<< HEAD

                <!-- NORMAL COST FIELD -->
                <div class="form-group" id="editNormalCostField">
                    <label for="editMaterialCost">Material Cost (‚Ç±)</label>
                    <input type="number" id="editMaterialCost" placeholder="Material Cost" step="0.01" min="0" required>
                </div>

                <!-- GLASS-SPECIFIC FIELDS -->
                <div id="editGlassFields" style="display:none; grid-column: span 1;">
                    <div class="form-group">
                        <label>Glass Width (ft)</label>
                        <input type="number" id="editGlassSize1" placeholder="Width" step="0.01">
                    </div>

                    <div class="form-group">
                        <label>Glass Height (ft)</label>
                        <input type="number" id="editGlassSize2" placeholder="Height" step="0.01">
                    </div>

                    <div class="form-group full-width">
                        <label>Cost per sqft (‚Ç±)</label>
                        <input type="number" id="editGlassActualCost" placeholder="Cost per sqft" step="0.01">
                    </div>
                </div>

=======
                <div class="form-group">
                    <label for="editMaterialCost">Material Cost (‚Ç±)</label>
                    <input type="number" id="editMaterialCost" placeholder="Material Cost" step="0.01" min="0" required>
                </div>
>>>>>>> 998790e18aa343458a92ca046fa99446a4bb0913
                <div class="form-group">
                    <label for="editCurrentStock">Current Stock</label>
                    <input type="number" id="editCurrentStock" placeholder="Current Stock" min="0" required>
                </div>
<<<<<<< HEAD

=======
>>>>>>> 998790e18aa343458a92ca046fa99446a4bb0913
                <div class="form-group">
                    <label for="editMinStock">Minimum Stock</label>
                    <input type="number" id="editMinStock" placeholder="Minimum Stock" min="0" required>
                </div>
<<<<<<< HEAD

=======
>>>>>>> 998790e18aa343458a92ca046fa99446a4bb0913
                <div class="form-group">
                    <label for="editMaxStock">Maximum Stock</label>
                    <input type="number" id="editMaxStock" placeholder="Maximum Stock" min="0" required>
                </div>
<<<<<<< HEAD

            </div> <!-- END GRID -->

        </div>

=======
            </div>
        </div>
>>>>>>> 998790e18aa343458a92ca046fa99446a4bb0913
        <div class="modal-actions">
            <button class="update-btn-modal" onclick="updateMaterial()">Update</button>
        </div>
    </div>
</div>

<<<<<<< HEAD

=======
>>>>>>> 998790e18aa343458a92ca046fa99446a4bb0913
<!-- Single Stock Modal -->
<div id="singleStockModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h4>Stock Material</h4>
      <span class="close" onclick="closeModal('singleStockModal')">&times;</span>
    </div>
    <div class="modal-body">
      <div class="stock-info-grid">
        <div class="info-card">
          <div class="info-label">Material</div>
          <!-- Changed to input so script can populate -->
          <input type="text" id="stockMaterialName" readonly class="info-value form-control-plaintext">
        </div>
        <div class="info-card">
          <div class="info-label">Current Stock</div>
          <!-- Changed to input so script can populate -->
          <input type="number" id="stockMaterialCurrent" readonly class="info-value form-control-plaintext">
        </div>
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label for="stockMaterialQty">Quantity to Add</label>
          <input type="number" id="stockMaterialQty" min="1" value="1" class="form-control">
        </div>
        <div class="form-group">
          <label for="singleStockSupplier">Supplier (optional)</label>
          <select id="singleStockSupplier" class="form-select">
            <option value="">-- Select Supplier --</option>
            <option value="supplier1">Supplier 1</option>
            <option value="supplier2">Supplier 2</option>
          </select>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-primary w-100" onclick="submitSingleStock()">Stock Material</button>
    </div>
  </div>
</div>


<!-- Filters -->
<div class="filters">
  
  <!-- Search -->
<div class="filter-left">
  <div class="filter-group">
    <button type="button" class="clear-filters-btn" onclick="clearMaterialFilters()">Clear Filters</button>
    <label for="searchInput">Search</label>
    <input type="text" id="searchInput" placeholder="Search materials...">

  </div>
</div>

<div class="filter-right">
  <!-- Category -->
  <div class="filter-group">
    <label for="categoryFilter">Category</label>
    <select id="categoryFilter">
      <option value="">All Categories</option>
    </select>
  </div>

  <!-- Availability -->
  <div class="filter-group">
    <label for="availabilityFilter">Availability</label>
    <select id="availabilityFilter">
      <option value="">All</option>
      <option value="In-stock">In-stock</option>
      <option value="Out of Stock">Out of Stock</option>
    </select>
  </div>

  <!-- Quantity Range -->
  <div class="filter-group range-group">
    <label>Quantity</label>
    <div class="range-inputs">
      <input type="number" id="minQty" placeholder="Min">
      <span>-</span>
      <input type="number" id="maxQty" placeholder="Max">
    </div>
  </div>

  <!-- Cost Range -->
  <div class="filter-group range-group">
    <label>Material Cost</label>
    <div class="range-inputs">
      <input type="number" id="minCost" placeholder="Min">
      <span>-</span>
      <input type="number" id="maxCost" placeholder="Max">
    </div>
  </div>

  <!-- Rating Range -->
  <div class="filter-group range-group">
    <label>Movement Rating (%)</label>
    <div class="range-inputs">
      <input type="number" id="minRating" placeholder="Min" step="0.01">
      <span>-</span>
      <input type="number" id="maxRating" placeholder="Max" step="0.01">
    </div>
  </div>

  <!-- Sorting -->
  <div class="filter-group">
    
    <label for="sortFilter">Sort By</label>
    <select id="sortFilter">
      <option value="">Default</option>
      <option value="nameAsc">Name A-Z</option>
      <option value="nameDesc">Name Z-A</option>
      <option value="qtyAsc">Quantity ‚Üë</option>
      <option value="qtyDesc">Quantity ‚Üì</option>
      <option value="costAsc">Cost ‚Üë</option>
      <option value="costDesc">Cost ‚Üì</option>
      <option value="ratingAsc">Rating ‚Üë</option>
      <option value="ratingDesc">Rating ‚Üì</option>
    </select>
  </div>
</div>
</div>

<div class="table-scroll">
  <table id="productTable">
    <thead>
      <tr>
        <th>Item ID</th>
        <th>Material</th>
        <th>Category</th>
        <th>Description</th>
        <th>Quantity</th>
        <th>Measurement</th>
        <th>Material Cost</th>
        <th>Movement Rating</th>
        <th>Availability</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="materialTableBody">
      <!-- Rows will be inserted dynamically via JavaScript -->
    </tbody>

  </table>
  <div class="pagination" id="pagination">
    <button onclick="changePage('stock', -1)">¬´ Prev</button>
    <span id="stockPageNumber">Page 1</span>
    <button onclick="changePage('stock', 1)">Next ¬ª</button>
  </div>
</div>

 <div>
 <main>
                 <!----------END OF MAIN------------->
<script>
  const notificationIcon = document.getElementById("notificationToggle");
  const dropdownMenu = document.getElementById("notificationDropdown");

  document.addEventListener("click", function (e) {
    const isInside = notificationIcon.contains(e.target) || dropdownMenu.contains(e.target);
    if (!isInside) {
      dropdownMenu.style.display = "none";
    }
  });

  notificationIcon.addEventListener("click", function (e) {
    e.stopPropagation();
    dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
  });

   function filterTable() {
      const input = document.getElementById("searchInput");
      const filter = input.value.toLowerCase();
      const table = document.getElementById("productTable");
      const trs = table.getElementsByTagName("tr");

      for (let i = 1; i < trs.length; i++) {
        const tds = trs[i].getElementsByTagName("td");
        let found = false;

       for (const td of tds) {
  if (td && td.innerText.toLowerCase().includes(filter)) {
    found = true;
    break;
  }
}


        trs[i].style.display = found ? "" : "none";
      }
    }

function openModal(modalId) {
  document.getElementById(modalId).style.display = "block";
  const today = new Date().toISOString().split('T')[0];

  if (modalId === 'createModal') {
    document.getElementById('createDate').value = today;

    // üõ†Ô∏è Load the suppliers and categories when opening create modal
    CreatefetchSuppliers(); 
    CreatefetchCategories();  
  } else if (modalId === 'updateModal') {
    document.getElementById('updateDate').value = today;

    // (Optional) Call fetch for update modal if needed
  }
}

function closePMModal() {
  const modal = document.getElementById('productMaterialModal');
  modal.style.display = 'none';
  document.getElementById('materialsContainer').innerHTML = '';
  document.getElementById('totalCost').textContent = '0.00';
  document.getElementById('productSelect').value = '';
}

document.getElementById('productMaterialModal').addEventListener('click', function (event) {
  const modalBox = document.querySelector('#productMaterialModal .modal-box');
  if (!modalBox.contains(event.target)) {
    closePMModal();
  }
});

function clearMaterialFilters() {
  // Reset filter input values
  document.getElementById("searchInput").value = "";
  document.getElementById("categoryFilter").value = "";
  document.getElementById("availabilityFilter").value = "";
  document.getElementById("minQty").value = "";
  document.getElementById("maxQty").value = "";
  document.getElementById("minCost").value = "";
  document.getElementById("maxCost").value = "";
  document.getElementById("minRating").value = "";
  document.getElementById("maxRating").value = "";
  document.getElementById("sortFilter").value = "";

  // Reset filtered data to original materialsData
  filteredData = [...materialsData];

  // Reset pagination
  currentPage = 1;

  // Re-render table and pagination
  renderTablePage(currentPage);
  renderPagination();
}


</script>

<script>
  const rowsPerPage = 8;
  let currentPage = 1;
  let materialsData = [];
  let filteredData = [];

  document.addEventListener("DOMContentLoaded", fetchMaterials);

  function getBarColor(rating) {
    if (rating >= 80) return "#4caf50";
    if (rating >= 50) return "#ffb300";
    return "#f44336";
  }

  async function fetchMaterials() {
    try {
      const response = await fetch("/api/materials");
      materialsData = await response.json();
      populateCategoryFilter();
      applyFilters();
    } catch (error) {
      console.error("Failed to load materials:", error);
    }
  }

  function populateCategoryFilter() {
    const categories = [...new Set(materialsData.map(m => m.item_category_name || "N/A"))];
    const categorySelect = document.getElementById("categoryFilter");
    categories.forEach(cat => {
      const option = document.createElement("option");
      option.value = cat;
      option.textContent = cat;
      categorySelect.appendChild(option);
    });
  }

  function applyFilters() {
    const searchValue = document.getElementById("searchInput").value.toLowerCase();
    const categoryValue = document.getElementById("categoryFilter").value;
    const availabilityValue = document.getElementById("availabilityFilter").value;
    const minQty = parseFloat(document.getElementById("minQty").value) || -Infinity;
    const maxQty = parseFloat(document.getElementById("maxQty").value) || Infinity;
    const minCost = parseFloat(document.getElementById("minCost").value) || -Infinity;
    const maxCost = parseFloat(document.getElementById("maxCost").value) || Infinity;
    const minRating = parseFloat(document.getElementById("minRating").value) || -Infinity;
    const maxRating = parseFloat(document.getElementById("maxRating").value) || Infinity;
    const sortValue = document.getElementById("sortFilter").value;

    filteredData = materialsData.filter(material => {
      const availability = material.current_stock === 0 ? "Out of Stock" : "In-stock";
      return (
        (material.material_id.toLowerCase().includes(searchValue) ||
         material.item_name.toLowerCase().includes(searchValue) ||
         (material.item_decription || "").toLowerCase().includes(searchValue)) &&
        (categoryValue === "" || material.item_category_name === categoryValue) &&
        (availabilityValue === "" || availability === availabilityValue) &&
        material.current_stock >= minQty && material.current_stock <= maxQty &&
        material.material_cost >= minCost && material.material_cost <= maxCost &&
        (material.fast_moving_rating || 0) >= minRating &&
        (material.fast_moving_rating || 0) <= maxRating
      );
    });

    filteredData.sort((a, b) => {
      switch (sortValue) {
        case "nameAsc": return a.item_name.localeCompare(b.item_name);
        case "nameDesc": return b.item_name.localeCompare(a.item_name);
        case "qtyAsc": return a.current_stock - b.current_stock;
        case "qtyDesc": return b.current_stock - a.current_stock;
        case "costAsc": return a.material_cost - b.material_cost;
        case "costDesc": return b.material_cost - a.material_cost;
        case "ratingAsc": return (a.fast_moving_rating || 0) - (b.fast_moving_rating || 0);
        case "ratingDesc": return (b.fast_moving_rating || 0) - (a.fast_moving_rating || 0);
        default: return 0;
      }
    });

    currentPage = 1;
    renderTablePage(currentPage);
    renderPagination();
  }

  function renderTablePage(page) {
    const tableBody = document.getElementById("materialTableBody");
    tableBody.innerHTML = "";

    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const pageData = filteredData.slice(start, end);

    pageData.forEach(material => {
      const statusData = material.current_stock === 0
        ? { status: "Out of Stock", class: "danger" }
        : { status: "In-stock", class: "success" };

      const { status, class: statusClass } = statusData;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${material.material_id}</td>
        <td>${material.item_name}</td>
        <td>${material.item_category_name || "N/A"}</td>
        <td>${material.item_decription || ""}</td>
        <td>${material.current_stock}</td>
        <td>${material.unit_measurement}</td>
        <td>‚Ç±${parseFloat(material.material_cost).toLocaleString()}</td>
        <td>
          <div class="rating-bar-wrapper">
            <div class="rating-bar-fill" style="width: ${material.fast_moving_rating || 0}%; background-color: ${getBarColor(material.fast_moving_rating)};"></div>
            <span class="rating-label">${material.fast_moving_rating?.toFixed(2) || "0.00"}%</span>
          </div>
        </td>
        <td class="${statusClass}">${status}</td>
        <td>
           <div class="action-buttons">
              {% if request.session['user']['role'] == 'admin' %}
              <button class="edit-btn" onclick="openEditModal('${material.material_id}')">Edit</button>
              <button class="delete-btn" onclick="deleteMaterial('${material.material_id}')">Delete</button>
              {% endif %}
              <button class="stock-btn" onclick="openSingleStockModal('${material.material_id}')">Stock</button>
            </div>
        </td>

      `;
      tableBody.appendChild(row);
    });
  }

  function renderPagination() {
    const paginationDiv = document.getElementById("pagination");
    paginationDiv.innerHTML = "";

    const totalPages = Math.ceil(filteredData.length / rowsPerPage);

    const prevBtn = document.createElement("button");
    prevBtn.textContent = "Prev";
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        renderTablePage(currentPage);
        renderPagination();
      }
    };
    paginationDiv.appendChild(prevBtn);

    for (let i = 1; i <= totalPages; i++) {
      const pageBtn = document.createElement("button");
      pageBtn.textContent = i;
      if (i === currentPage) {
        pageBtn.disabled = true;
        pageBtn.style.fontWeight = "bold";
      }
      pageBtn.onclick = () => {
        currentPage = i;
        renderTablePage(currentPage);
        renderPagination();
      };
      paginationDiv.appendChild(pageBtn);
    }

    const nextBtn = document.createElement("button");
    nextBtn.textContent = "Next";
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => {
      if (currentPage < totalPages) {
        currentPage++;
        renderTablePage(currentPage);
        renderPagination();
      }
    };
    paginationDiv.appendChild(nextBtn);
  }

  function formatDate() {
    const now = new Date();
    return now.toLocaleDateString("en-US", {
      year: "numeric",
      month: "short",
      day: "numeric",
    });
  }

  function openEditModal(id) {
    alert(`Open edit modal for material ID: ${id}`);
  }

  document.querySelectorAll("#searchInput, #categoryFilter, #availabilityFilter, #minQty, #maxQty, #minCost, #maxCost, #minRating, #maxRating, #sortFilter")
    .forEach(el => el.addEventListener("input", applyFilters));
</script>

<!-- Add api -->
<script>
function openModal(modalId) {
  document.getElementById(modalId).style.display = "block";
  const today = new Date().toISOString().split('T')[0];

  if (modalId === 'createModal') {
    document.getElementById('createDate').value = today;
  }
}


// Populate dropdowns
async function fetchCategoriesAndSuppliers() {
  const supplierSelect = document.getElementById("createSupplier");
  const categorySelect = document.getElementById("createCategory");

  try {
    const [suppliersRes, categoriesRes] = await Promise.all([
      fetch("/api/suppliers"),
      fetch("/api/material-categories")
    ]);

    const [suppliers, categories] = await Promise.all([
      suppliersRes.json(),
      categoriesRes.json()
    ]);

    supplierSelect.innerHTML = '<option value="" disabled selected>Select a supplier</option>';
    categorySelect.innerHTML = '<option value="" disabled selected>Select a category</option>';

    suppliers.forEach(supplier => {
      const option = document.createElement("option");
      option.value = supplier.id;
      option.text = supplier.contact_name;
      supplierSelect.appendChild(option);
    });

    categories.forEach(category => {
      const option = document.createElement("option");
      option.value = category.id;
      option.text = category.category_name;
      categorySelect.appendChild(option);
    });

  } catch (error) {
    console.error("Error fetching data:", error);
  }
}

// Call the fetch function on load
document.addEventListener("DOMContentLoaded", fetchCategoriesAndSuppliers);

// Submit Material
async function addMaterial() {
  const item_name = document.getElementById("createItemName").value;
  const item_decription = document.getElementById("createDescription").value;
  const supplier_id = document.getElementById("createSupplier").value;
  const category_id = document.getElementById("createCategory").value;
  const unit_measurement = document.getElementById("createUnitMeasurement").value;
  const current_stock = parseFloat(document.getElementById("createQuantity").value);
  const minimum_stock = parseFloat(document.getElementById("createMinStock").value);
  const maximum_stock = parseFloat(document.getElementById("createMaxStock").value);

  let material_cost;

  // Detect glass
const isGlass = item_name.trim().toLowerCase().includes("glass");

if (isGlass) {
    const s1 = parseFloat(document.getElementById("glassSize1").value);
    const s2 = parseFloat(document.getElementById("glassSize2").value);
    const cost = parseFloat(document.getElementById("glassActualCost").value);

    if (isNaN(s1) || isNaN(s2) || isNaN(cost))
        return alert("Please fill all glass size and cost fields.");

    // Multiply to get final cost
    material_cost = s1 * s2 * cost;
} 
else {
    material_cost = parseFloat(document.getElementById("createUnitCost").value);
}


  // Validation
  if (!item_name) return alert("Item name is required.");
  if (!item_decription) return alert("Item description is required.");
  if (!category_id) return alert("Please select a category.");
  if (!supplier_id) return alert("Please select a supplier.");
  if (!unit_measurement) return alert("Unit measurement is required.");

  // Validate material cost only when it's a number
  if (!isGlass) {
    if (isNaN(material_cost) || material_cost < 0)
      return alert("Material cost must be a positive number.");
  }

  if (isNaN(current_stock) || current_stock < 0) return alert("Current stock must be a positive number.");
  if (isNaN(minimum_stock) || minimum_stock < 0) return alert("Minimum stock must be a positive number.");
  if (isNaN(maximum_stock) || maximum_stock < 0) return alert("Maximum stock must be a positive number.");
  if (maximum_stock < minimum_stock) return alert("Maximum stock cannot be less than minimum stock.");

  const newMaterial = {
    item_name,
    item_decription,
    supplier_id,
    category_id,
    unit_measurement,
    material_cost,
    current_stock,
    minimum_stock,
    maximum_stock
  };

  try {
    const response = await fetch("/api/materials", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(newMaterial)
    });

    if (response.ok) {
      alert("Material added successfully!");
      closeModal("createModal");
      location.reload();
    } else {
      const err = await response.json();
      alert("Failed to add material:\n" + (err.detail || "Unknown error"));
    }

  } catch (error) {
    console.error("Error adding material:", error);
    alert("Something went wrong.");
  }
}



</script>

<!-- Delete api -->
<script>
  // Fetch materials to populate the delete selector dropdown
  async function fetchMaterialsForDelete() {
    try {
      const response = await fetch("/api/materials"); // Ensure this is correct
      if (!response.ok) {
        throw new Error("Failed to fetch materials");
      }

      const materials = await response.json();
      const materialSelect = document.getElementById("deleteMaterialSelector");

      // Clear old options
      materialSelect.innerHTML = "<option value=''>Select Material</option>";

      // Check if materials are returned
      if (materials.length === 0) {
        console.log("No materials found.");
        return;
      }

      // Populate the dropdown with material names
      materials.forEach(material => {
        const option = document.createElement("option");
        option.value = material.material_id; // Use material_id as value
        option.textContent = material.item_name; // Display material name
        materialSelect.appendChild(option);
      });
    } catch (error) {
      console.error("Failed to load materials for delete:", error);
    }
  }

  // Update the hidden input when a material is selected
  function updateMaterialId() {
    const materialId = document.getElementById("deleteMaterialSelector").value;
    document.getElementById("deleteItemId").value = materialId;
  }

  // Open the delete modal and load materials
  function openDeleteModal() {
    document.getElementById("deleteModal").style.display = "block";
    fetchMaterialsForDelete(); // Load materials when the modal is opened
  }



  // Delete the selected material
 async function deleteMaterial(materialId) {
  const confirmDelete = confirm(`Are you sure you want to delete Material ID: ${materialId}?`);
  if (!confirmDelete) return;

  try {
    const response = await fetch(`/api/materials/${materialId}`, {
      method: "DELETE"
    });

    const result = await response.json();

    if (!response.ok) {
      alert("Error: " + (result.message || result.detail || "Unknown error"));
      return;
    }

    alert(result.message || "Material deleted successfully.");
    fetchMaterials(); // Refresh material list after deletion
  } catch (err) {
    console.error("Failed to delete material:", err);
    alert("Failed to delete material. Please try again.");
  }
}


  // Close the modal when clicking outside the modal
  window.onclick = function(event) {
    const modal = document.getElementById("deleteModal");
    if (event.target === modal) {
      closeModal("deleteModal");
    }
  };

  // Make sure that this function is properly called when the page is ready
  document.addEventListener("DOMContentLoaded", () => {
    fetchMaterialsForDelete(); // Initial call to populate the dropdown when the page is loaded
  });

  // Watch item/material name input
document.addEventListener("DOMContentLoaded", () => {
  const itemNameInput = document.getElementById("createItemName");
  const unitCostContainer = document.getElementById("unitCostContainer");

  itemNameInput.addEventListener("input", handleUnitCostDisplay);

  function handleUnitCostDisplay() {
    const value = itemNameInput.value.trim().toLowerCase();

    const containsGlass = value.includes("glass");

    if (containsGlass) {
      // Show 3-input layout
      unitCostContainer.innerHTML = `
        <label>Unit Cost (Glass):</label>
        <div style="display:flex; gap:6px;">
          <input type="number" id="glassSize1" placeholder="Size 1" min="0" step="any">
          <input type="number" id="glassSize2" placeholder="Size 2" min="0" step="any">
          <input type="number" id="glassActualCost" placeholder="Unit Cost" min="0" step="any">
        </div>
      `;

      // Try to auto-detect size
      detectAndFillGlassSize(value);
    } 
    else {
      // Normal unit cost input
      unitCostContainer.innerHTML = `
        <label>Unit Cost:</label>
        <input type="number" id="createUnitCost" min="0" step="any">
      `;
    }
  }

  function detectAndFillGlassSize(text) {
    // Match patterns like 4x8, 4 x 8, 4X8, 4*8, etc.
    const sizePattern = /(\d+)\s*[xX*by]+\s*(\d+)/;

    const match = text.match(sizePattern);
    if (!match) return;  // No size found

    const size1 = parseFloat(match[1]);
    const size2 = parseFloat(match[2]);

    const size1Input = document.getElementById("glassSize1");
    const size2Input = document.getElementById("glassSize2");

    if (size1Input && size2Input) {
      size1Input.value = size1;
      size2Input.value = size2;
    }
  }
});
</script>
<!-- Update api -->
 <script>
function attachStockWarning() {
  const stockInput = document.getElementById('editCurrentStock');

  stockInput.addEventListener('change', function () {
    alert("‚ö†Ô∏è Warning: Changing 'Current Stock' will NOT generate a stock transaction history.");
  });
}
</script>

<script>
// --- Utility function to extract glass size from item name ---
function extractGlassSize(str) {
    const match = str.match(/(\d+(\.\d+)?)\s*x\s*(\d+(\.\d+)?)/i);
    if (!match) return null;
    return { s1: parseFloat(match[1]), s2: parseFloat(match[3]) };
}

// --- Open Edit Modal ---
async function openEditModal(materialId) {
    document.getElementById("editModal").style.display = "block";

    try {
        const response = await fetch("/api/materials");
        const materials = await response.json();
        const material = materials.find(mat => mat.material_id == materialId);

        if (!material) return console.error("Material not found");

        // Fill basic fields
        document.getElementById("editMaterialId").value = material.material_id;
        document.getElementById("editItemName").value = material.item_name;
        document.getElementById("editItemDescription").value = material.item_decription;
        document.getElementById("editCurrentStock").value = material.current_stock;
        document.getElementById("editMinStock").value = material.minimum_stock;
        document.getElementById("editMaxStock").value = material.maximum_stock;
        document.getElementById("editUnitMeasurement").value = material.unit_measurement;

        // Load dropdowns
        await fetchCategories(material.category_id);
        await fetchSuppliers(material.supplier_id);

        // Attach warning for stock changes
        const stockInput = document.getElementById("editCurrentStock");
        stockInput.onchange = () => {
            alert("‚ö†Ô∏è Warning: Changing 'Current Stock' will NOT generate a stock transaction history.");
        };

        // --- Glass detection ---
        const nameLower = material.item_name.toLowerCase();
        const glassSize = extractGlassSize(material.item_name);

        if (nameLower.includes("glass") && glassSize) {
            // Show glass fields
            document.getElementById("editGlassFields").style.display = "grid";
            document.getElementById("editNormalCostField").style.display = "none";

            // Fill sizes
            document.getElementById("editGlassSize1").value = glassSize.s1;
            document.getElementById("editGlassSize2").value = glassSize.s2;

            // Reverse calculate cost per sqft
            const actualCost = material.material_cost / (glassSize.s1 * glassSize.s2);
            document.getElementById("editGlassActualCost").value = actualCost.toFixed(2);

        } else {
            // Normal material
            document.getElementById("editGlassFields").style.display = "none";
            document.getElementById("editNormalCostField").style.display = "block";
            document.getElementById("editMaterialCost").value = material.material_cost;
        }

    } catch (error) {
        console.error("Failed to load material data:", error);
    }
}

// --- Update Material ---
async function updateMaterial() {
    const materialId = document.getElementById('editMaterialId').value;
    const itemName = document.getElementById('editItemName').value.trim();
    const itemDescription = document.getElementById('editItemDescription').value.trim();
    const categoryId = document.getElementById('editCategory').value;
    const supplierId = document.getElementById('editSupplier').value;
    const unitMeasurement = document.getElementById('editUnitMeasurement').value;
    const currentStock = parseInt(document.getElementById('editCurrentStock').value, 10);
    const minimumStock = parseFloat(document.getElementById('editMinStock').value);
    const maximumStock = parseFloat(document.getElementById('editMaxStock').value);

    // Validate basic fields
    if (!itemName) return alert("Item name is required.");
    if (!itemDescription) return alert("Item description is required.");
    if (!categoryId) return alert("Please select a category.");
    if (!supplierId) return alert("Please select a supplier.");
    if (!unitMeasurement) return alert("Unit measurement is required.");
    if (isNaN(currentStock) || currentStock < 0) return alert("Current stock must be a positive number.");
    if (isNaN(minimumStock) || minimumStock < 0) return alert("Minimum stock must be a positive number.");
    if (isNaN(maximumStock) || maximumStock < 0) return alert("Maximum stock must be a positive number.");
    if (maximumStock < minimumStock) return alert("Maximum stock cannot be less than minimum stock.");

    // --- Calculate final cost ---
    let finalCost;
    const nameLower = itemName.toLowerCase();
    const glassSize = extractGlassSize(itemName);

    if (nameLower.includes("glass") && glassSize) {
        const s1 = parseFloat(document.getElementById("editGlassSize1").value);
        const s2 = parseFloat(document.getElementById("editGlassSize2").value);
        const actualCost = parseFloat(document.getElementById("editGlassActualCost").value);

        if (isNaN(s1) || isNaN(s2) || isNaN(actualCost) || s1 <= 0 || s2 <= 0 || actualCost <= 0) {
            return alert("Please fill all glass size and cost fields with positive numbers.");
        }

        finalCost = s1 * s2 * actualCost;
    } else {
        finalCost = parseFloat(document.getElementById("editMaterialCost").value);
        if (isNaN(finalCost) || finalCost <= 0) return alert("Material cost must be a positive number.");
    }

    // --- Prepare payload ---
    const materialData = {
        material_id: materialId,
        item_name: itemName,
        item_description: itemDescription,
        category_id: categoryId,
        supplier_id: supplierId,
        unit_measurement: unitMeasurement,
        material_cost: finalCost,
        current_stock: currentStock,
        minimum_stock: minimumStock,
        maximum_stock: maximumStock
    };

    // --- Send update ---
    try {
        const response = await fetch(`/api/material/update`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(materialData)
        });

        const result = await response.json();

        if (response.ok) {
            alert("Material updated successfully!");
            closeModal("editModal");
            fetchMaterials();  // Refresh the table
        } else {
            alert("Error:\n" + JSON.stringify(result, null, 2));
        }
    } catch (error) {
        console.error("Failed to update material:", error);
        alert("Error updating material. Please try again.");
    }
}

// --- Fetch categories and set selected ---
async function fetchCategories(selectedId = null) {
    try {
        const response = await fetch("/api/material-categories");
        const categories = await response.json();
        const categorySelect = document.getElementById("editCategory");

        categorySelect.innerHTML = "";
        categories.forEach(category => {
            const option = document.createElement("option");
            option.value = String(category.id);
            option.textContent = category.category_name;
            if (String(category.id) === String(selectedId)) option.selected = true;
            categorySelect.appendChild(option);
        });
    } catch (error) {
        console.error("Failed to load categories", error);
    }
}

// --- Fetch suppliers and set selected ---
async function fetchSuppliers(selectedId = null) {
    try {
        const response = await fetch("/api/suppliers");
        const suppliers = await response.json();
        const supplierSelect = document.getElementById("editSupplier");

        supplierSelect.innerHTML = "";
        suppliers.forEach(supplier => {
            const option = document.createElement("option");
            option.value = String(supplier.id);
            option.textContent = supplier.contact_name;
            if (String(supplier.id) === String(selectedId)) option.selected = true;
            supplierSelect.appendChild(option);
        });
    } catch (error) {
        console.error("Failed to load suppliers", error);
    }
}

// --- Close modal on outside click ---
window.onclick = function(event) {
    const modal = document.getElementById("editModal");
    if (event.target === modal) closeModal("editModal");
};
</script>


<!-- Stock api -->
<script>
async function openModal(id) {
  await loadSuppliers();
  await loadMaterials(); // preload material options

  const container = document.getElementById("materialsList");
  container.innerHTML = ""; // clear previous entries

  addMaterialInput();    // add one material input initially
  document.getElementById(id).style.display = "block";
}

function toggleSupplierForm() {
  const fields = document.getElementById("newSupplierFields");
  const btn = document.getElementById("toggleSupplierBtn");
  const isHidden = fields.style.display === "none";
  fields.style.display = isHidden ? "block" : "none";
  btn.textContent = isHidden ? "Hide New Supplier" : "Add New Supplier";
}

function closeModal(id) {
  document.getElementById(id).style.display = "none";
  document.getElementById("materialsList").innerHTML = ""; 
}

async function loadSuppliers() {
  const response = await fetch("/api/suppliers");
  const suppliers = await response.json();
  const select = document.getElementById("supplierId");
  select.innerHTML = `<option value="">-- Add New Supplier --</option>`;
  suppliers.forEach(s => {
    select.innerHTML += `<option value="${s.id}">${s.contact_name}</option>`;
  });
}

let materialOptions = [];

async function loadMaterials() {
  const response = await fetch("/api/materials");
  materialOptions = await response.json();
}

function addMaterialInput() {
  const container = document.getElementById("materialsList");
  const index = container.children.length;

  const materialHTML = `
    <div class="material-entry mt-2" id="material-entry-${index}">
      <select class="material-id" required>
        <option value="">-- Select Material --</option>
        ${materialOptions.map(m => `<option value="${m.material_id}">${m.item_name}</option>`).join('')}
      </select>
      <input type="number" placeholder="Quantity" class="material-quantity" min="1" required>
      <button type="button" onclick="removeMaterialInput(${index})">Remove</button>
    </div>
  `;
  container.insertAdjacentHTML("beforeend", materialHTML);
}

function removeMaterialInput(index) {
  const el = document.getElementById(`material-entry-${index}`);
  if (el) el.remove();
}

async function submitStockMaterials(event) {
  event.preventDefault();

  const stockTypeId = "STT001"; //Always use Manual Stock-in
  const supplierId = document.getElementById("supplierId").value.trim() || null;

  const supplier = {
    firstname: document.getElementById("supplierFirstname").value,
    lastname: document.getElementById("supplierLastname").value,
    contact_name: document.getElementById("supplierContactName").value,
    contact_number: document.getElementById("supplierContactNumber").value,
    email: document.getElementById("supplierEmail").value,
    address: document.getElementById("supplierAddress").value,
  };

  const items = Array.from(document.querySelectorAll("#materialsList .material-entry")).map(entry => {
    const material_id = entry.querySelector(".material-id").value;
    const quantity = parseInt(entry.querySelector(".material-quantity").value);
    return { material_id, quantity };
  });

  const payload = {
    stock_type_id: stockTypeId,
    supplier_id: supplierId,
    supplier: (!supplierId && Object.values(supplier).some(v => v)) ? supplier : null,
    items
  };

  try {
    const response = await fetch("/api/stock-materials", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await response.json();
    if (response.ok) {
      alert("Materials successfully stocked!");
      closeModal('stockMaterialsModal');
      location.reload();
    } else {
      alert("Error: " + result.detail);
    }
  } catch (err) {
    alert("Request failed: " + err.message);
  }
}

async function openSingleStockModal(materialId) {
  if (!materialOptions || materialOptions.length === 0) {
    await loadMaterials();
  }

  const material = materialOptions.find(m => m.material_id === materialId);
  if (!material) return alert("Material not found!");

  // Populate modal fields
  const qtyInput = document.getElementById("stockMaterialQty");
  const currentStockInput = document.getElementById("stockMaterialCurrent");

  document.getElementById("stockMaterialName").value = material.item_name;
  currentStockInput.value = material.current_stock || 0;
  qtyInput.value = 1;
  document.getElementById("singleStockModal").dataset.materialId = materialId;

  // Validation: Ensure quantity is a positive integer
  qtyInput.min = 1;
  qtyInput.addEventListener("input", () => {
    if (qtyInput.value === "" || qtyInput.value < 1) {
      qtyInput.value = 1;
    } else {
      qtyInput.value = Math.floor(qtyInput.value);
    }
  });

  // Load suppliers into dropdown
  const supplierSelect = document.getElementById("singleStockSupplier");
  supplierSelect.innerHTML = `<option value="">-- Select Supplier --</option>`;
  try {
    const response = await fetch("/api/suppliers");
    const suppliers = await response.json();
    suppliers.forEach(s => {
      supplierSelect.innerHTML += `<option value="${s.id}">${s.contact_name}</option>`;
    });
  } catch (err) {
    alert("Failed to load suppliers: " + err.message);
  }

  // Show modal
  document.getElementById("singleStockModal").style.display = "block";
}


async function submitSingleStock() {
  const materialId = document.getElementById("singleStockModal").dataset.materialId;
  const quantity = parseInt(document.getElementById("stockMaterialQty").value);
  const supplierId = document.getElementById("singleStockSupplier").value || null;

  if (!materialId) return alert("Material not specified!");
  if (!quantity || quantity < 1) return alert("Enter a valid quantity");
  if (!supplierId) return alert("Please select a supplier");

  if (!quantity || quantity < 1) return alert("Enter a valid quantity");

  try {
    const payload = {
      stock_type_id: "STT001",
      supplier_id: supplierId,
      items: [{ material_id: materialId, quantity }]
    };

    const response = await fetch("/api/stock-materials", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await response.json();
    if (response.ok) {
      alert("Material stocked successfully!");
      closeModal("singleStockModal");
      location.reload();
    } else {
      alert("Error: " + result.detail);
    }
  } catch (err) {
    alert("Request failed: " + err.message);
  }
}

</script>

<!-- Product Materials -->
<script>
let materialsList = [];
let existingMaterialCosts = {};

async function openAddProductMaterialModal() {
  const [productsRes, materialsRes] = await Promise.all([
    fetch('/api/products'),
    fetch('/api/materials')
  ]);

  const products = await productsRes.json();
  materialsList = await materialsRes.json();

  const productSelect = document.getElementById('productSelect');
  productSelect.innerHTML = '';

  const defaultOption = document.createElement('option');
  defaultOption.value = '';
  defaultOption.textContent = '-- Select Product --';
  productSelect.appendChild(defaultOption);

  products.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.product_id;
    opt.textContent = p.item_name;
    productSelect.appendChild(opt);
  });

  document.getElementById('materialsContainer').innerHTML = '';
  productSelect.removeEventListener('change', handleProductChange);
  productSelect.addEventListener('change', handleProductChange);

  document.getElementById('productMaterialModal').style.display = 'flex';
}

async function handleProductChange(event) {
  const productId = event.target.value;
  await loadExistingMaterials(productId);
}

function updateUnitLabel(selectElement) {
  const selectedOption = selectElement.options[selectElement.selectedIndex];
  const unit = selectedOption?.getAttribute("data-unit") || "";
  const container = selectElement.closest(".material-entry");
  const unitLabel = container.querySelector(".unit-label");
  unitLabel.textContent = unit ? `(${unit})` : "";
}

function updateTotalCost() {
  let total = 0;
  document.querySelectorAll('.material-entry').forEach(div => {
    const qty = parseFloat(div.querySelector('.used-quantity')?.value) || 0;
    const cost = parseFloat(div.querySelector('.unit-cost')?.value) || 0;
    total += qty * cost;
  });
  document.getElementById('totalCost').textContent = total.toFixed(2);
}

function checkDuplicateMaterial(selectedId, currentSelect) {
  if (!selectedId) return false;
  const allSelects = Array.from(document.querySelectorAll('.material-select'));
  return allSelects.some(select => select !== currentSelect && select.value === selectedId);
}

function addMaterialField(data = {}, isExisting = false, productId = '') {
  const container = document.getElementById('materialsContainer');
  const div = document.createElement('div');
  div.classList.add('material-entry');

  const materialOptions = materialsList.map(m =>
    `<option value="${m.material_id}" data-unit="${m.unit_measurement}" ${m.material_id === data.material_id ? 'selected' : ''}>
      ${m.item_name}
    </option>`
  ).join('');

  div.innerHTML = `
    <label>Material:</label>
    <select class="material-select" onchange="handleMaterialChange(this)" ${isExisting ? 'disabled' : ''}>
      <option value="">-- Select Material --</option>
      ${materialOptions}
    </select>

    <label>Used Quantity: <span class="unit-label"></span></label>
    <input type="number" class="used-quantity" placeholder="Used Quantity" step="0.01"
      value="${data.used_quantity ?? ''}" ${isExisting ? '' : ''} oninput="updateTotalCost()">

    <label>Unit Cost:</label>
    <input type="number" class="unit-cost" placeholder="Unit Cost" step="0.01"
      value="${data.unit_cost ?? ''}" ${isExisting ? '' : ''} oninput="updateTotalCost()">

    ${isExisting ? `
      <button onclick="updateMaterialField(this, '${productId}', '${data.material_id}')">Update</button>
      <button onclick="deleteMaterialField(this, '${productId}', '${data.material_id}')">Delete</button>
    ` : `
      <button onclick="removeMaterialField(this, event)">Remove</button>
    `}
    <br><br>
  `;

  container.appendChild(div);
  const selectElement = div.querySelector('.material-select');
  updateUnitLabel(selectElement);
  updateTotalCost();
}

function handleMaterialChange(selectElement) {
  const selectedId = selectElement.value;
  if (checkDuplicateMaterial(selectedId, selectElement)) {
    alert("This material has already been added.");
    selectElement.value = "";
    updateUnitLabel(selectElement);
    return;
  }

  const container = selectElement.closest('.material-entry');
  updateUnitLabel(selectElement);

  const unitCostInput = container.querySelector('.unit-cost');
  if (existingMaterialCosts[selectedId]) {
      unitCostInput.value = existingMaterialCosts[selectedId];
  } else {
      // 2. Otherwise, fetch cost from materials list (NORMAL behavior)
      const mat = materialsList.find(m => m.material_id == selectedId);
      if (mat) {
          unitCostInput.value = mat.material_cost || 0;
      }
  }

  updateTotalCost();
}

async function loadExistingMaterials(productId) {
  document.getElementById('materialsContainer').innerHTML = '';
  existingMaterialCosts = {};

  if (!productId) return;

  const res = await fetch(`/api/product-materials/${productId}`);
  if (!res.ok) {
    console.error("Failed to load existing materials");
    return;
  }

  const existingMaterials = await res.json();
  existingMaterials.forEach(m => {
    existingMaterialCosts[m.material_id] = m.unit_cost;
    addMaterialField(m, true, productId);
  });

  updateTotalCost();
}

async function submitProductMaterials() {
  const product_id = document.getElementById('productSelect').value;
  const materialDivs = document.querySelectorAll('.material-entry');

  // Get only new (non-disabled) material rows
  const materials = Array.from(materialDivs)
    .filter(div => !div.querySelector('.material-select')?.disabled)
    .map(div => {
      return {
        material_id: div.querySelector('.material-select').value,
        used_quantity: parseFloat(div.querySelector('.used-quantity').value),
        unit_cost: parseFloat(div.querySelector('.unit-cost').value)
      };
    });

  // Validation checks
  if (!product_id) {
    alert('Please select a product.');
    return;
  }

  if (materials.length === 0) {
    alert('No new materials to add.');
    return;
  }

  if (materials.some(m => !m.material_id || isNaN(m.used_quantity) || isNaN(m.unit_cost))) {
    alert('Please complete all material fields.');
    return;
  }

  // Send to backend
  const res = await fetch('/api/product-materials/add', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ product_id, materials })
  });

  if (res.ok) {
    alert('Materials added successfully.');
    closePMModal();
  } else {
    const error = await res.json();
    alert(`Error: ${error.detail}`);
  }
}


async function updateMaterialField(button, productId, materialId) {
  const entry = button.closest('.material-entry');
  const used_quantity = parseFloat(entry.querySelector('.used-quantity').value);
  const unit_cost = parseFloat(entry.querySelector('.unit-cost').value);

  if (isNaN(used_quantity) || isNaN(unit_cost)) {
    alert("Please enter valid quantity and cost.");
    return;
  }

  const res = await fetch('/api/product-materials/update', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ product_id: productId, material_id: materialId, used_quantity, unit_cost })
  });

  if (res.ok) {
    alert("Material updated.");
  } else {
    const error = await res.json();
    alert(`Error: ${error.detail}`);
  }
}

async function deleteMaterialField(button, productId, materialId) {
  if (!confirm("Are you sure you want to delete this material from the product?")) return;

  const res = await fetch(`/api/product-materials/delete?product_id=${productId}&material_id=${materialId}`, {
    method: 'DELETE'
  });

  if (res.ok) {
    alert("Material deleted.");
    button.closest('.material-entry').remove();
    updateTotalCost();
  } else {
    const error = await res.json();
    alert(`Error: ${error.detail}`);
  }
}

function closeModal() {
  document.getElementById('productMaterialModal').style.display = 'none';
  document.getElementById('materialsContainer').innerHTML = '';
  document.getElementById('totalCost').textContent = '0.00';
  document.getElementById('productSelect').value = '';
}

document.getElementById('productMaterialModal').addEventListener('click', function (event) {
  const modalBox = document.querySelector('#productMaterialModal .modal-box');
  if (!modalBox.contains(event.target)) {
    closeModal();
  }
});

function removeMaterialField(button, event) {
  event.stopPropagation();
  button.parentElement.remove();
  updateTotalCost();
}
</script>

<!-- Materials Summary Card -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  fetch('/api/summary/materials')
    .then(response => response.json())
    .then(data => {
      // Card 1: 
      document.getElementById("total-materials").textContent = data.total_materials ?? 0;

      // Card 2:
      const topMaterial = data.most_used_material;
      document.getElementById("most-used-material").textContent = topMaterial.item_name || 'N/A';
      document.getElementById("top-material-count").textContent = topMaterial.total_used ?? '-';

      // Card 3:
      document.getElementById("total-material-quantity").textContent = data.total_material_quantity ?? 0;
    })
    .catch(error => {
      console.error('Error fetching material summary:', error);
    });
});
</script>

<script>
window.onclick = function(event) {
  const modalIds = [
    "createModal",
    "updateModal",
    "deleteModal",
    "stockMaterialsModal",
    "editModal",
    "productMaterialModal",
    "singleStockModal"
  ];
  
  modalIds.forEach(modalId => {
    const modal = document.getElementById(modalId);
    if (modal && event.target === modal) {
      modal.style.display = "none";
    }
  });
};
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = "none";
    }
}


function clearCreateMaterialsInputs() {
  document.getElementById("createItemName").value = "";
  document.getElementById("createDescription").value = "";
  document.getElementById("createSupplier").selectedIndex = 0;
  document.getElementById("createCategory").selectedIndex = 0;
  document.getElementById("createUnitMeasurement").selectedIndex = 0;
  document.getElementById("createUnitCost").value = "";
  document.getElementById("createQuantity").value = "";
  document.getElementById("createMinStock").value = "";
  document.getElementById("createMaxStock").value = "";
}

</script>

</body>
</html>
